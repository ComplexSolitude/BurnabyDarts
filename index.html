 <!DOCTYPE html>
<!--suppress ALL -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Burnaby Arms - Darts Scorer</title>
    <link rel="icon" type="image/x-icon" href="burnaby-logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="burnaby-logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="burnaby-logo.png">
    <link rel="apple-touch-icon" href="darts-icon-v3.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // noinspection JSUnresolvedReference
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://cdnjs.cloudflare.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://*.googleapis.com https://*.firebaseapp.com; frame-src https://accounts.google.com https://darts-app-9e752.firebaseapp.com;">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <style>
        body { font-family: 'Inter', sans-serif; }
       #toast-notification {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .toast-hidden {
            transform: translateX(-50%) translateY(-100%) !important;
            opacity: 0 !important;
        }

        .toast-visible {
            transform: translateX(-50%) translateY(1.25rem) !important;
            opacity: 1 !important;
        }
         .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 60px;
            height: 60px;
            animation: pulse-effect 0.25s ease-in-out infinite;
        }
        @keyframes pulse-effect {
            0%, 100% {
             transform: scale(1);
            }
            50% {
                transform: scale(1.1);  
            }
        }
        .tab-enter {
            animation: tabEnter 0.3s ease forwards;
        }
        .tab-leave {
            animation: tabLeave 0.3s ease forwards;
        }
        @keyframes tabEnter {
            from { opacity: 0; transform: translateY(0.5rem); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes tabLeave {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-0.5rem); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); color: inherit; }
            50% { transform: scale(1.05); color: #fbbf24; }
        }
        #current-player-names.animate-pulse {
            animation: pulse 0.6s ease;
        }
        #main-app {
          position: relative;
          z-index: 1;
          min-height: 100vh;
        }
        
        body::before {
          content: '';
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-image: url('burnaby-logo.png');
          background-repeat: no-repeat;
          background-position: center 65%;
          background-size: 350px;
          opacity: 0.05;
          z-index: -1;
        }
        body.modal-open {
          overflow: hidden;
        }
    </style>
    <!-- HTTPS Redirect -->
    <script>
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        location.replace('https:' + window.location.href.substring(window.location.protocol.length));
    }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Dev Environment Indicator -->
    <div id="dev-indicator" class="fixed top-4 right-1/4 z-[9998] bg-orange-500 text-white px-3 py-2 rounded-lg shadow-lg text-xs font-bold hidden">
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
            </svg>
            <div>
                <div>DEV MODE</div>
                <div id="dev-db-info" class="text-orange-200 text-xs"></div>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-gradient-to-br from-green-800/90 to-gray-900/90 backdrop-blur-sm opacity-100 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 text-center shadow-xl">
            <img src="burnaby-logo.png" alt="Loading..." class="spinner mx-auto mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Signing you in...</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400">Please wait a moment</p>
        </div>
    </div>
    <!-- Role Selection Overlay -->
    <div id="role-selection-overlay" class="fixed inset-0 bg-gray-800/70 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm text-center">
            <img src="burnaby-logo.png" alt="Burnaby Arms Logo" class="h-32 w-32 mx-auto mb-4">
            <h1 class="text-4xl font-bold text-white mb-2">Burnaby Arms B</h1>
            <p class="text-lg text-gray-300 mb-8">Darts Scorer</p>
            <div class="space-y-4">
                <button data-role="viewer" class="role-btn w-full bg-gray-200 text-gray-800 py-3 px-4 rounded-xl font-semibold text-lg hover:bg-gray-300 transition-colors">View Only</button>
                <div class="space-y-3">
                    <div id="email-signin-form" class="space-y-3">
                        <input type="email" id="email-input" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900">
                        <input type="password" id="password-input" placeholder="Password" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900">
                        <button id="email-signin-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-xl font-semibold text-lg hover:bg-green-700 transition-colors">Sign In with Email</button>
                    </div>
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-gray-800 text-gray-400">or</span>
                        </div>
                    </div>
                    <button id="google-signin-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold text-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span id="signin-btn-text">Sign in with Google</span>
                    </button>
                    <button id="create-account-btn" class="w-full bg-gray-600 text-white py-2 px-4 rounded-xl font-medium hover:bg-gray-700 transition-colors">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="main-app" class="hidden max-w-4xl mx-auto p-2 sm:p-4 lg:p-8">

            <!-- App Header -->
    <header class="relative flex justify-between items-center mb-4 px-2 h-16">
        <div>
            <button id="header-signout-btn" class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-200">
                Sign Out
            </button>
        </div>
    
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center whitespace-nowrap">
            <img src="burnaby-logo.png" alt="Logo" class="h-12 w-12 mr-1">
            <h1 class="text-l font-semibold text-gray-900 dark:text-white">Darts Scorer</h1>
            <img src="burnaby-logo.png" alt="Logo" class="h-12 w-12 ml-1">
        </div>
    
        <div class="md:hidden">
            <button id="hamburger-btn" class="p-2">
                <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
    </header>


        <!-- Connection Status -->
        <div id="connection-status" class="text-center p-4 mb-4 bg-yellow-100 text-yellow-800 rounded-xl hidden">Connecting to database...</div>

        <!-- Main Content Area with Border -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <!-- Desktop Tabs Navigation -->
            <div id="desktop-nav" class="hidden md:block">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex justify-center flex-wrap p-4" aria-label="Tabs">
                        <button id="tab-btn-match" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Current Match</button>
                        <button id="tab-btn-live" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Scoring</button>
                        <button id="tab-btn-fixtures" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Fixtures</button>
                        <button id="tab-btn-fines" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Fines</button>
                        <button id="tab-btn-stats" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Stats</button>
                        <button id="tab-btn-h2h" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Head-to-Head</button>
                        <button id="tab-btn-my-profile" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">My Profile</button>
                        <button id="tab-btn-setup" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Setup</button>
                        <button id="tab-btn-admin" class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm transition-colors duration-200">Admin</button>
                    </nav>
                </div>
            </div>

            <!-- Tab Content Area -->
            <div class="relative p-4 sm:p-6">
                <!-- Current Match Tab -->
                <div id="tab-content-match">
                    <div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Current Match</h2>
                            <div class="flex gap-2">
                                <button id="match-view-team-a" class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">A Team</button>
                                <button id="match-view-team-b" class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">B Team</button>
                            </div>
                        </div>
                        <p id="current-match-opponent" class="mt-1 text-sm text-gray-600 dark:text-gray-400">Live results as they come in.</p>
                        <div id="current-match-score-container" class="my-4"></div>
                        <div id="current-match-results" class="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-4"></div>
                    </div>
                </div>

                <!-- Fixtures Tab -->
                <div id="tab-content-fixtures" class="hidden">
                    <!-- Fixtures Sub-tabs -->
                    <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Fixture Tabs">
                            <button id="fixtures-tab-upcoming" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-emerald-600 border-emerald-500">Upcoming</button>
                            <button id="fixtures-tab-previous" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Previous</button>
                        </nav>
                        <div class="flex gap-2 mb-2">
                            <button id="fixtures-view-team-a" class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">A Team</button>
                            <button id="fixtures-view-team-b" class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">B Team</button>
                        </div>
                    </div>

                    <!-- Upcoming Fixtures Panel -->
                    <div id="fixtures-content-upcoming">
                        <p class="text-center text-gray-500 dark:text-gray-400 mb-4">Click on a match to see details</p>
                        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold dark:text-white">Upcoming Matches</h2>
                                <button id="add-fixture-btn" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-emerald-700 transition-colors">+ Add</button>
                            </div>
                            <div id="upcoming-fixtures-list" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Previous Fixtures Panel -->
                    <div id="fixtures-content-previous" class="hidden">
                        <p class="text-center text-gray-500 dark:text-gray-400 mb-4">Click on a match to see details</p>
                        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 dark:text-white">Match History</h2>
                            <div id="previous-fixtures-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Fines Tab -->
                <div id="tab-content-fines" class="hidden">
                     <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                          <div class="p-4 sm:p-6">
                               <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Outstanding Fines</h2>
                               <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Track and clear player fines that are yet to be paid.</p>
                          </div>
                          <div id="fines-list" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                          <!-- Pay Fine Button Container -->
                          <div id="pay-fine-container" class="p-4 sm:p-6 border-t border-gray-200 dark:border-gray-700 hidden">
                               <a href="https://monzo.me/jacobrobertfordham?h=8XgSRd" target="_blank" class="block w-full text-center bg-emerald-600 text-white py-3 px-4 rounded-xl hover:bg-emerald-700 transition-colors duration-200 font-semibold">
                                    Pay My Fine
                               </a>
                          </div>
                     </div>
                </div>

                <!-- Match Setup Tab -->
                <div id="tab-content-setup" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
                        <!-- Left Column -->
                        <div>
                           <!-- Player roster moved to Admin tab -->
                            <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                                <h2 class="text-xl font-semibold mb-4 dark:text-white">Season Management</h2>
                                <div id="seasons-list" class="space-y-3 mb-4"></div>
                                <div id="add-season-form" class="space-y-2">
                                    <input type="text" id="new-season-name-input" aria-label="New Season Input" placeholder="e.g., Summer 25" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <button id="add-season-btn" class="w-full bg-gray-800 dark:bg-gray-600 text-white py-2 px-4 rounded-xl hover:bg-gray-700 dark:hover:bg-gray-500 transition-colors duration-200">Add New Season</button>
                                </div>
                            </div>
                        </div>
                        <!-- Right Column -->
                        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 dark:text-white">Setup New Match</h2>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Season</label>
                                <p id="active-season-display" class="mt-1 text-lg font-semibold text-emerald-600 dark:text-emerald-400"></p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Opposition Name</label>
                                <input type="text" id="opposition-name-input" aria-label="Opposition Name" placeholder="e.g., The King's Arms" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="mb-4">
                                <label for="match-date-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Match Date (optional)</label>
                                <input type="date" id="match-date-input" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leave blank to use today's date.</p>
                            </div>
                            <div id="fixture-setup-form" class="space-y-4"></div>
                            <div class="mt-6">
                                <button id="create-fixture-btn" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-xl hover:bg-emerald-700 transition-colors duration-200 font-semibold text-lg">Create & Start Fixture</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Scoring Tab -->
                <div id="tab-content-live" class="hidden">
                    <div id="live-match-content">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-game-btn" class="bg-gray-800 dark:bg-gray-600 text-white py-2 px-4 sm:px-5 rounded-xl hover:bg-gray-700 dark:hover:bg-gray-500 disabled:opacity-50 transition-colors duration-200 text-sm sm:text-base">Prev</button>
                            <h2 id="game-nav-title" class="text-xl sm:text-2xl font-bold text-center mx-2 dark:text-white"></h2>
                            <button id="next-game-btn" class="bg-gray-800 dark:bg-gray-600 text-white py-2 px-4 sm:px-5 rounded-xl hover:bg-gray-700 dark:hover:bg-gray-500 disabled:opacity-50 transition-colors duration-200 text-sm sm:text-base">Next</button>
                        </div>
                        <div id="live-scoring-score-container" class="mb-4"></div>
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <h3 id="current-player-names" class="text-2xl sm:text-3xl font-bold text-center text-emerald-600 dark:text-emerald-400 mb-6"></h3>

                            <!-- Shared Stats -->
                            <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                                <div class="bg-gray-100 dark:bg-gray-700 p-3 sm:p-4 rounded-2xl">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300">Legs Won</label>
                                    <div class="flex items-center justify-center space-x-3 mt-2">
                                        <button data-stat="legsWon" data-op="-1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">-</button>
                                        <span id="stat-legsWon" class="text-3xl font-bold dark:text-white">0</span>
                                        <button data-stat="legsWon" data-op="1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">+</button>
                                    </div>
                                </div>
                                 <div class="bg-gray-100 dark:bg-gray-700 p-3 sm:p-4 rounded-2xl">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300">Legs Lost</label>
                                    <div class="flex items-center justify-center space-x-3 mt-2">
                                        <button data-stat="legsLost" data-op="-1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">-</button>
                                        <span id="stat-legsLost" class="text-3xl font-bold dark:text-white">0</span>
                                        <button data-stat="legsLost" data-op="1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">+</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Singles Scoring -->
                            <div id="singles-scoring-panel" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-6">
                                <div class="bg-gray-100 dark:bg-gray-700 p-2 sm:p-4 rounded-2xl flex-1 text-center min-w-[140px]">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300">100+</label>
                                    <div class="flex items-center justify-center space-x-3 mt-2">
                                        <button data-stat="scores100" data-op="-1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">-</button>
                                        <span id="stat-scores100" class="text-3xl font-bold dark:text-white">0</span>
                                        <button data-stat="scores100" data-op="1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">+</button>
                                    </div>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 p-2 sm:p-4 rounded-2xl flex-1 text-center min-w-[140px]">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300">140+</label>
                                    <div class="flex items-center justify-center space-x-3 mt-2">
                                        <button data-stat="scores140" data-op="-1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">-</button>
                                        <span id="stat-scores140" class="text-3xl font-bold dark:text-white">0</span>
                                        <button data-stat="scores140" data-op="1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">+</button>
                                    </div>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 p-2 sm:p-4 rounded-2xl flex-1 text-center min-w-[140px]">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300">180s</label>
                                    <div class="flex items-center justify-center space-x-3 mt-2">
                                        <button data-stat="scores180" data-op="-1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">-</button>
                                        <span id="stat-scores180" class="text-3xl font-bold dark:text-white">0</span>
                                        <button data-stat="scores180" data-op="1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">+</button>
                                    </div>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 p-2 sm:p-4 rounded-2xl flex-1 text-center min-w-[140px]">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300">?</label>
                                    <div class="flex items-center justify-center space-x-3 mt-2">
                                        <button data-stat="sillyThings" data-op="-1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">-</button>
                                        <span id="stat-sillyThings" class="text-3xl font-bold dark:text-white">0</span>
                                        <button data-stat="sillyThings" data-op="1" class="stat-btn w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xl font-bold">+</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Doubles Scoring -->
                            <div id="doubles-scoring-panel" class="hidden mb-6">
                                <div class="grid grid-cols-1 gap-4">
                                    <!-- Player 1 -->
                                    <div class="border border-gray-200 dark:border-gray-700 p-3 sm:p-4 rounded-2xl">
                                        <h4 id="doubles-p1-name" class="text-lg font-semibold text-center mb-3 dark:text-white"></h4>
                                        <div class="flex flex-wrap justify-center gap-2">
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">100+</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="scores100" data-op="-1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p1-scores100" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="scores100" data-op="1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">140+</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="scores140" data-op="-1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p1-scores140" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="scores140" data-op="1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">180s</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="scores180" data-op="-1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p1-scores180" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="scores180" data-op="1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">?</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="sillyThings" data-op="-1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p1-sillyThings" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="sillyThings" data-op="1" data-player-index="0" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Player 2 -->
                                    <div class="border border-gray-200 dark:border-gray-700 p-3 sm:p-4 rounded-2xl">
                                        <h4 id="doubles-p2-name" class="text-lg font-semibold text-center mb-3 dark:text-white"></h4>
                                        <div class="flex flex-wrap justify-center gap-2">
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">100+</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="scores100" data-op="-1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p2-scores100" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="scores100" data-op="1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">140+</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="scores140" data-op="-1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p2-scores140" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="scores140" data-op="1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">180s</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="scores180" data-op="-1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p2-scores180" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="scores180" data-op="1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="bg-gray-100 dark:bg-gray-600 p-2 rounded-xl flex-1 text-center min-w-[120px]">
                                                <label class="text-xs font-medium text-gray-600 dark:text-gray-300">?</label>
                                                <div class="flex items-center justify-center space-x-2 mt-1">
                                                    <button data-stat="sillyThings" data-op="-1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">-</button>
                                                    <span id="stat-p2-sillyThings" class="text-2xl font-bold dark:text-white">0</span>
                                                    <button data-stat="sillyThings" data-op="1" data-player-index="1" class="stat-btn w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-500 text-gray-700 dark:text-gray-200 font-bold">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6 max-w-xs mx-auto">
                                <label for="high-checkout-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-center">High Checkout (H/C)</label>
                                <input type="number" id="high-checkout-input" class="mt-1 block w-full text-center text-xl p-2 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div id="fines-panel" class="mb-8 border-t dark:border-gray-700 pt-6">
                                <h4 class="text-lg font-semibold text-center mb-3 dark:text-white">Game Incidents</h4>
                                <div class="flex justify-center flex-wrap gap-2 mb-4">
                                    <button id="fine-btn-26" class="bg-red-500 text-white py-2 px-3 rounded-xl hover:bg-red-600 transition-colors duration-200 text-sm">26 (26p)</button>
                                    <button id="fine-btn-miss" class="bg-red-500 text-white py-2 px-3 rounded-xl hover:bg-red-600 transition-colors duration-200 text-sm">Miss Board (50p)</button>
                                    <button id="fine-btn-low-score" class="bg-red-500 text-white py-2 px-3 rounded-xl hover:bg-red-600 transition-colors duration-200 text-sm">Score &lt; 10</button>
                                </div>
                                <div id="fines-list-current-game" class="mb-4">
                                    <!-- Individual fines will be populated here -->
                                </div>
                                <p class="text-center text-gray-600 dark:text-gray-400">Total Fines: <span id="stat-fines" class="font-bold">£0.00</span></p>
                            </div>
                            <div id="game-action-buttons" class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <button id="finish-match-btn" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-xl hover:bg-emerald-700 transition-colors duration-200 font-semibold text-lg hidden">Finish Game & Save Stats</button>
                            </div>
                        </div>
                    </div>
                    <div id="no-fixture-message" class="hidden text-center text-gray-500 dark:text-gray-400 p-10">
                        <p>No active fixture. Please go to Match Setup to start a new one.</p>
                    </div>
                </div>

                <!-- League Stats Tab -->
                 <div id="tab-content-stats" class="hidden">
                    <div class="px-4 sm:px-6 py-4 space-y-4">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h2 class="text-xl font-semibold dark:text-white">Season Leaderboard</h2>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 items-center">
                                <button id="toggle-columns-btn" class="bg-gray-600 dark:bg-gray-700 text-white px-3 py-2 rounded-xl hover:bg-gray-700 dark:hover:bg-gray-600 transition-colors text-sm">
                                    Show/Hide Columns
                                </button>
                                <select id="team-filter-select" aria-label="Team Filter" class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="all">All Teams</option>
                                    <option value="A">A Team</option>
                                    <option value="B">B Team</option>
                                </select>
                                <select id="season-filter-select" aria-label="Season Filter" class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></select>
                            </div>
                        </div>
                        
                        <!-- Column Visibility Controls -->
                        <div id="column-controls" class="hidden bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Choose Columns to Display</h3>
                                <div class="flex gap-2">
                                    <button id="select-all-columns" class="text-xs bg-emerald-600 text-white px-2 py-1 rounded hover:bg-emerald-700 transition-colors">Select All</button>
                                    <button id="deselect-all-columns" class="text-xs bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-700 transition-colors">Clear All</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="gamesPlayed" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                                    <span class="dark:text-gray-300">Games Played</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="gamesWon" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="dark:text-gray-300">Games Won</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="gamesLost" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                                    <span class="dark:text-gray-300">Games Lost</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="legsWon" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="dark:text-gray-300">Legs Won</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="legsLost" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                                    <span class="dark:text-gray-300">Legs Lost</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="legWinPercent" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="dark:text-gray-300">Leg Win %</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="scores100" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="dark:text-gray-300">100+ Scores</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="scores140" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                                    <span class="dark:text-gray-300">140+ Scores</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="scores180" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="dark:text-gray-300">180 Scores</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="highCheckout" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="dark:text-gray-300">High Checkout</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" data-column="totalFines" class="column-checkbox rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                                    <span class="dark:text-gray-300">Total Fines</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr id="stats-table-header">
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Player</th>
                                    <th scope="col" data-sort="gamesPlayed" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Games Played">P</th>
                                    <th scope="col" data-sort="gamesWon" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Games Won">GW</th>
                                    <th scope="col" data-sort="gamesLost" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Games Lost">GL</th>
                                    <th scope="col" data-sort="legsWon" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Legs Won">LW</th>
                                    <th scope="col" data-sort="legsLost" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Legs Lost">LL</th>
                                    <th scope="col" data-sort="legWinPercent" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Leg Win Percentage">Leg %</th>
                                    <th scope="col" data-sort="scores100" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">100+</th>
                                    <th scope="col" data-sort="scores140" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">140+</th>
                                    <th scope="col" data-sort="scores180" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">180s</th>
                                    <th scope="col" data-sort="highCheckout" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">H/C</th>
                                    <th scope="col" data-sort="totalFines" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" title="Total Fines Accrued">Fines</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Head-to-Head Tab Content -->
                <div id="tab-content-h2h" class="hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4">Head-to-Head</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                        <div>
                            <label for="h2h-player1-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Player 1</label>
                            <select id="h2h-player1-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="h2h-player2-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Player 2</label>
                            <select id="h2h-player2-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></select>
                        </div>
                    </div>
                    <div id="h2h-results-container" class="mt-6">
                        <p class="text-center text-gray-500 dark:text-gray-400">Select two different players to compare their stats.</p>
                    </div>
                </div>

                <!-- My Profile Tab -->
                <div id="tab-content-my-profile" class="hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4">My Profile</h2>
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                             <div class="mb-4">
                                <label for="my-profile-player-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select Your Profile (for now)</label>
                                <select id="my-profile-player-select" class="mt-1 block w-full max-w-xs py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></select>
                             </div>
                             <div id="my-profile-edit-area" class="hidden space-y-4">
                                <div>
                                    <label for="my-profile-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                                    <input type="text" id="my-profile-name" class="mt-1 w-full max-w-xs px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label for="my-profile-nickname" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nickname</label>
                                    <input type="text" id="my-profile-nickname" placeholder="e.g., The Captain" class="mt-1 w-full max-w-xs px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div class="pt-2">
                                    <button id="my-profile-save-btn" class="bg-emerald-600 text-white py-2 px-4 rounded-xl hover:bg-emerald-700 transition-colors duration-200 font-semibold">Save Changes</button>
                                </div>
                             </div>
                        </div>
                         <div id="my-profile-stats-area" class="hidden">
                             <!-- Player card content will be injected here -->
                         </div>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div id="tab-content-admin" class="hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Admin Panel</h2>
                    <div id="admin-content-area" class="mt-4"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 ease-in-out">
        <div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg p-6 flex flex-col transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Menu</h2>
                <button id="close-menu-btn" class="p-2 text-gray-800 dark:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col space-y-4 flex-grow">
                <!-- Links will be dynamically inserted here by JS -->
            </nav>
            <!-- Theme Toggle in Menu -->
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button id="theme-toggle-btn-mobile" class="w-full flex items-center justify-between text-lg text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md">
                    <span>Switch Theme</span>
                    <span class="relative w-6 h-6">
                        <svg id="theme-icon-sun-mobile" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg id="theme-icon-moon-mobile" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div id="player-card-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-4 sm:p-6 w-full max-w-2xl relative">
             <button id="player-card-close-btn" class="absolute top-3 right-3 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-3xl leading-none">&times;</button>
             <div id="player-card-content"></div>
        </div>
    </div>

    <div id="low-score-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4 dark:text-white">Enter Score (&lt;10)</h3>
            <input type="number" id="low-score-input" aria-label="Low Score Input" min="1" max="9" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl text-center text-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="1-9">
            <div class="flex justify-end space-x-3 mt-4">
                <button id="low-score-cancel" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-xl">Cancel</button>
                <button id="low-score-submit" class="bg-emerald-600 text-white py-2 px-4 rounded-xl">Add Fine</button>
            </div>
        </div>
    </div>

    <div id="dotd-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md relative">
            <button id="dotd-close-btn" class="absolute top-3 right-3 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-3xl leading-none">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 dark:text-white">Vote for DOTD</h3>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">The player with the most votes receives a £2.50 fine.</p>
            <div id="dotd-vote-list" class="space-y-3 mb-6"></div>
            <button id="dotd-finish-btn" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-xl font-semibold">Confirm Winner & Finish Match</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-modal-title" class="text-xl font-semibold mb-2 dark:text-white">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-gray-600 dark:text-gray-400 mb-4">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="confirm-modal-cancel" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-xl">Cancel</button>
                <button id="confirm-modal-confirm" class="bg-red-600 text-white py-2 px-4 rounded-xl">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Create Account Modal -->
        <div id="signup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 modal-overlay p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold dark:text-white">Create Account</h3>
                    <button id="signup-modal-close" class="text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="signup-password" placeholder="Enter password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label for="signup-confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" placeholder="Confirm password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="signup-modal-cancel" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-xl">Cancel</button>
                    <button id="signup-modal-submit" class="bg-green-600 text-white py-2 px-4 rounded-xl hover:bg-green-700 transition-colors">Create Account</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Profile Management Modal -->
    <div id="profile-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold dark:text-white">Manage Player Profiles</h3>
                <button id="profile-management-close" class="text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="profile-player-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Player</label>
                    <select id="profile-player-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Choose a player...</option>
                    </select>
                </div>
                <div id="profile-edit-section" class="hidden space-y-4">
                    <div>
                        <label for="profile-edit-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                        <input type="text" id="profile-edit-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="profile-edit-nickname" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nickname</label>
                        <input type="text" id="profile-edit-nickname" placeholder="Optional nickname" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="profile-edit-team" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Team</label>
                        <select id="profile-edit-team" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">No Team</option>
                            <option value="A">A Team</option>
                            <option value="B">B Team</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="profile-edit-cancel" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-xl">Cancel</button>
                        <button id="profile-edit-save" class="bg-emerald-600 text-white py-2 px-4 rounded-xl hover:bg-emerald-700 transition-colors">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-0 left-1/2 text-white py-3 px-5 rounded-xl shadow-lg z-50 toast-hidden text-center w-11/12 max-w-md flex items-center gap-2" role="alert">
        <svg id="toast-icon" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"></svg>
        <span id="toast-message"></span>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        // noinspection JSFileReferences
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // noinspection JSFileReferences
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, runTransaction, query, updateDoc, serverTimestamp, increment, writeBatch, Timestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signOut as firebaseSignOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const provider = new GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');

        // --- APPLICATION STATE ---
        const state = {
            db: null,
            auth: null,
            userId: null,
            unsubscribeFunctions: null,
            userEmail: null,
            userName: null,
            userRole: null, // null, 'viewer', 'member', 'admin'
            userPlayerId: null, // Link to player profile
            userTeam: null,
            activeMatchView: null,
            isLoggedIn: false,
            signingIn: false,
            activeTab: 'match',
            players: [],
            seasons: [],
            activeSeasonId: null,
            selectedStatsSeasonId: 'all-time',
            selectedStatsTeamFilter: 'all', // 'all', 'A', or 'B'
            playerCard: { isOpen: false, playerId: null, selectedSeasonId: 'all-time' },
            fixture: { id: null, games: [], activeGameIndex: 0 },
            previousFixtures: [],
            upcomingFixtures: [],
            selectedPreviousFixtureId: null,
            selectedUpcomingFixtureId: null,
            activeFixturesTab: 'upcoming',
            currentGameIndex: 0,
            lastTurnSeq: 0,
            confirmation: { action: null, data: null },
            loginAttemptRole: null,
            logoutTimer: null,
            h2h: {
                player1: null,
                player2: null,
            },
            myProfile: {
                selectedPlayerId: null,
            },
            leaderboardSort: { // New state for sorting
                column: 'gamesWon',
                direction: 'desc' // 'asc' or 'desc'
            },
            columnVisibility: { // New state for column visibility
                gamesPlayed: false,
                gamesWon: true,
                gamesLost: false,
                legsWon: true,
                legsLost: false,
                legWinPercent: true,
                scores100: true,
                scores140: false,
                scores180: true,
                highCheckout: true,
                totalFines: false
            }
        };

        const rateLimiter = {
            requests: new Map(),

            isAllowed(operation = 'general', limit = 100, windowMs = 60000) {
                const userId = state.userId || 'anonymous';
                const key = `${userId}-${operation}`;
                const now = Date.now();

                const userRequests = this.requests.get(key) || [];
                const recentRequests = userRequests.filter(time => now - time < windowMs);

                if (recentRequests.length >= limit) {
                    return false;
                }

                this.requests.set(key, [...recentRequests, now]);
                return true;
            },

            checkAndBlock(operation, limit, windowMs) {
                if (!this.isAllowed(operation, limit, windowMs)) {
                    throw new Error(`Rate limit exceeded for ${operation}. Please wait before trying again.`);
                }
            }
        };

        // Wrapper for Firebase operations
        const safeFirebaseCall = async (operation, firebaseFunction) => {
            rateLimiter.checkAndBlock(operation, 50, 60000); // 50 requests per minute
            return await firebaseFunction();
        };

        // Input validation function
        function validateInput(input, maxLength = 100) {
            if (typeof input !== 'string') {
                throw new Error('Input must be a string');
            }

            if (input.length > maxLength) {
                throw new Error(`Input too long (max ${maxLength} characters)`);
            }

            // Check for potentially malicious content
            const dangerousPatterns = [
                /<script/i,
                /javascript:/i,
                /data:/i,
                /vbscript:/i,
                /onload=/i,
                /onerror=/i
            ];

            for (const pattern of dangerousPatterns) {
                if (pattern.test(input)) {
                    throw new Error('Invalid characters detected');
                }
            }

            return input.trim();
        }

        // Storage validation function
        function validateStoredData() {
            const allowedRoles = ['viewer', 'scorer', 'member', 'admin'];
            const storedRole = localStorage.getItem('userRole');

            if (storedRole && !allowedRoles.includes(storedRole)) {
                console.warn('Invalid role in storage, clearing...');
                localStorage.removeItem('userRole');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('loginTimestamp');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userId');
                resetSignInButtonState();
                return false;
            }

            // Validate login timestamp
            const loginTimestamp = Number(localStorage.getItem('loginTimestamp'));
            if (loginTimestamp && (Date.now() - loginTimestamp > SESSION_DURATION_MS)) {
                console.warn('Session expired, clearing storage...');
                localStorage.removeItem('userRole');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('loginTimestamp');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userId');
                resetSignInButtonState();
                return false;
            }

            return true;
        }


        // --- CONSTANTS ---
        const SESSION_DURATION_MS = 8 * 60 * 60 * 1000; // 8 hours
        const GAME_TITLES = ["Singles 1", "Singles 2", "Singles 3", "Singles 4", "Singles 5", "Doubles 1", "Doubles 2"];
        const PLAYERS_COLLECTION = 'players';
        const FIXTURES_COLLECTION = 'fixtures';
        const SEASONS_COLLECTION = 'seasons';

        // --- DOM ELEMENTS ---
        const ui = {
            tabs: { match: document.getElementById('tab-btn-match'), live: document.getElementById('tab-btn-live'), fixtures: document.getElementById('tab-btn-fixtures'), fines: document.getElementById('tab-btn-fines'), stats: document.getElementById('tab-btn-stats'), h2h: document.getElementById('tab-btn-h2h'), 'my-profile': document.getElementById('tab-btn-my-profile'), setup: document.getElementById('tab-btn-setup'), admin: document.getElementById('tab-btn-admin') },
            headerSignoutBtn: document.getElementById('header-signout-btn'),
            content: { match: document.getElementById('tab-content-match'), live: document.getElementById('tab-content-live'), fixtures: document.getElementById('tab-content-fixtures'), fines: document.getElementById('tab-content-fines'), stats: document.getElementById('tab-content-stats'), h2h: document.getElementById('tab-content-h2h'), 'my-profile': document.getElementById('tab-content-my-profile'), setup: document.getElementById('tab-content-setup'), admin: document.getElementById('tab-content-admin') },
            toast: { element: document.getElementById('toast-notification'), message: document.getElementById('toast-message'), icon: document.getElementById('toast-icon') },
            mainApp: document.getElementById('main-app'),
            roleSelectionOverlay: document.getElementById('role-selection-overlay'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            themeToggleBtnMobile: document.getElementById('theme-toggle-btn-mobile'),
            themeIconsMobile: { sun: document.getElementById('theme-icon-sun-mobile'), moon: document.getElementById('theme-icon-moon-mobile') },
            desktopNav: document.getElementById('desktop-nav'),
            mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
            mobileNavLinks: document.getElementById('mobile-nav-links'),
            closeMenuBtn: document.getElementById('close-menu-btn'),
            adminContentArea: document.getElementById('admin-content-area'),
            connectionStatus: document.getElementById('connection-status'),
            addSeasonForm: document.getElementById('add-season-form'),
            oppositionNameInput: document.getElementById('opposition-name-input'),
            matchDateInput: document.getElementById('match-date-input'),
            fixtureForm: document.getElementById('fixture-setup-form'),
            createFixtureBtn: document.getElementById('create-fixture-btn'),
            seasonsList: document.getElementById('seasons-list'),
            newSeasonInput: document.getElementById('new-season-name-input'),
            addSeasonBtn: document.getElementById('add-season-btn'),
            activeSeasonDisplay: document.getElementById('active-season-display'),
            seasonFilterSelect: document.getElementById('season-filter-select'),
            liveMatchContent: document.getElementById('live-match-content'),
            noFixtureMessage: document.getElementById('no-fixture-message'),
            gameNavTitle: document.getElementById('game-nav-title'),
            prevGameBtn: document.getElementById('prev-game-btn'),
            nextGameBtn: document.getElementById('next-game-btn'),
            currentPlayerNames: document.getElementById('current-player-names'),
            statValueSpans: {
                legsWon: document.getElementById('stat-legsWon'),
                legsLost: document.getElementById('stat-legsLost'),
                fines: document.getElementById('stat-fines'),
                scores100: document.getElementById('stat-scores100'),
                scores140: document.getElementById('stat-scores140'),
                scores180: document.getElementById('stat-scores180'),
                sillyThings: document.getElementById('stat-sillyThings'),
                p1_scores100: document.getElementById('stat-p1-scores100'),
                p1_scores140: document.getElementById('stat-p1-scores140'),
                p1_scores180: document.getElementById('stat-p1-scores180'),
                p1_sillyThings: document.getElementById('stat-p1-sillyThings'),
                p2_scores100: document.getElementById('stat-p2-scores100'),
                p2_scores140: document.getElementById('stat-p2-scores140'),
                p2_scores180: document.getElementById('stat-p2-scores180'),
                p2_sillyThings: document.getElementById('stat-p2-sillyThings'),
            },
            doublesPlayerNames: { p1: document.getElementById('doubles-p1-name'), p2: document.getElementById('doubles-p2-name') },
            highCheckoutInput: document.getElementById('high-checkout-input'),
            finesPanel: document.getElementById('fines-panel'),
            finesListCurrentGame: document.getElementById('fines-list-current-game'),
            gameActionButtons: document.getElementById('game-action-buttons'),
            leaderboardBody: document.getElementById('leaderboard-body'),
            currentMatchResults: document.getElementById('current-match-results'),
            currentMatchOpponent: document.getElementById('current-match-opponent'),
            currentMatchScoreContainer: document.getElementById('current-match-score-container'),
            liveScoringScoreContainer: document.getElementById('live-scoring-score-container'),
            upcomingFixturesList: document.getElementById('upcoming-fixtures-list'),
            previousFixturesList: document.getElementById('previous-fixtures-list'),
            addFixtureBtn: document.getElementById('add-fixture-btn'),
            fixturesTabUpcoming: document.getElementById('fixtures-tab-upcoming'),
            fixturesTabPrevious: document.getElementById('fixtures-tab-previous'),
            fixturesContentUpcoming: document.getElementById('fixtures-content-upcoming'),
            fixturesContentPrevious: document.getElementById('fixtures-content-previous'),
            finesList: document.getElementById('fines-list'),
            payFineContainer: document.getElementById('pay-fine-container'),
            singlesScoringPanel: document.getElementById('singles-scoring-panel'),
            doublesScoringPanel: document.getElementById('doubles-scoring-panel'),
            playerCardModal: { overlay: document.getElementById('player-card-modal'), content: document.getElementById('player-card-content'), closeBtn: document.getElementById('player-card-close-btn') },
            lowScoreModal: { overlay: document.getElementById('low-score-modal'), input: document.getElementById('low-score-input'), cancel: document.getElementById('low-score-cancel'), submit: document.getElementById('low-score-submit') },
            dotdModal: { overlay: document.getElementById('dotd-modal'), list: document.getElementById('dotd-vote-list'), finish: document.getElementById('dotd-finish-btn') },
            confirmModal: { overlay: document.getElementById('confirm-modal'), title: document.getElementById('confirm-modal-title'), text: document.getElementById('confirm-modal-text'), cancel: document.getElementById('confirm-modal-cancel'), confirm: document.getElementById('confirm-modal-confirm') },
            fineBtn26: document.getElementById('fine-btn-26'),
            fineBtnMiss: document.getElementById('fine-btn-miss'),
            fineBtnLowScore: document.getElementById('fine-btn-low-score'),
            h2h: {
                player1Select: document.getElementById('h2h-player1-select'),
                player2Select: document.getElementById('h2h-player2-select'),
                resultsContainer: document.getElementById('h2h-results-container'),
            },
            myProfile: {
                playerSelect: document.getElementById('my-profile-player-select'),
                editArea: document.getElementById('my-profile-edit-area'),
                statsArea: document.getElementById('my-profile-stats-area'),
                nameInput: document.getElementById('my-profile-name'),
                nicknameInput: document.getElementById('my-profile-nickname'),
                saveBtn: document.getElementById('my-profile-save-btn'),
            }
        };

        function getNextUpcomingMatch(teamFilter = null) {
            if (state.upcomingFixtures.length === 0) return null;
        
            const now = new Date();
            const upcoming = state.upcomingFixtures
                .filter(fixture => {
                    const matchDate = fixture.scheduledDate?.toDate ? fixture.scheduledDate.toDate() : new Date(fixture.scheduledDate);
                    const isUpcoming = matchDate >= now;
                    const matchesTeam = !teamFilter || fixture.team === teamFilter;
                    return isUpcoming && matchesTeam;
                })
                .sort((a, b) => {
                    const dateA = a.scheduledDate?.toDate ? a.scheduledDate.toDate() : new Date(a.scheduledDate);
                    const dateB = b.scheduledDate?.toDate ? b.scheduledDate.toDate() : new Date(b.scheduledDate);
                    return dateA - dateB;
                });
        
            return upcoming[0] || null;
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            renderAuth();
            renderTabs();
            updateTeamSwitcherStyles('match');
            updateTeamSwitcherStyles('fixtures');
            renderSeasonManagement();
            renderFixturePlayerSelectors();
            renderFixtureSetup();
            renderLiveMatch();
            renderLeaderboard();
            renderCurrentMatch();
            renderFixturesTab();
            renderFines();
            renderH2HTab();
            renderMyProfile();
        }

        function renderAuth() {
            // Show/hide header buttons based on login status
            if (state.isLoggedIn) {
                ui.headerSignoutBtn.classList.remove('hidden');
                ui.headerSignoutBtn.textContent = 'Sign Out';
            } else if (state.userRole === 'viewer') {
                ui.headerSignoutBtn.classList.remove('hidden');
                ui.headerSignoutBtn.textContent = 'Sign In';
            } else {
                ui.headerSignoutBtn.classList.add('hidden');
            }
            ui.adminContentArea.innerHTML = '';

            if (state.isLoggedIn) {
                const loggedInContainer = document.createElement('div');
                loggedInContainer.className = 'space-y-6';

                // Admin Sub-tabs Navigation
                const adminSubTabs = document.createElement('div');
                adminSubTabs.className = 'border-b border-gray-200 dark:border-gray-700 mb-6';
                adminSubTabs.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Admin Tabs">
                            <button id="admin-tab-users" class="admin-sub-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-emerald-600 border-emerald-500">Users</button>
                            <button id="admin-tab-players" class="admin-sub-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Players</button>
                        </nav>
                        <select id="admin-team-filter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                            <option value="all">All Teams</option>
                            <option value="A">Team A</option>
                            <option value="B">Team B</option>
                            <option value="none">No Team</option>
                        </select>
                    </div>
                `;
                loggedInContainer.appendChild(adminSubTabs);

                // Users Content Panel
                const usersPanel = document.createElement('div');
                usersPanel.id = 'admin-panel-users';
                usersPanel.className = 'max-w-2xl';

                // User info section
                const userInfoDiv = document.createElement('div');
                userInfoDiv.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-xl';
                userInfoDiv.innerHTML = `
                    <div class="text-gray-600 dark:text-gray-300">
                        <p>Signed in as <span class="font-bold capitalize">${state.userRole}</span></p>
                        <p class="text-sm">${state.userEmail}</p>
                        ${state.userName ? `<p class="text-sm">${state.userName}</p>` : ''}
                        ${state.userTeam ? `<p class="text-sm font-semibold">Team: ${state.userTeam}</p>` : '<p class="text-sm text-yellow-600 dark:text-yellow-400 font-semibold">⚠ No team assigned</p>'}
                    </div>
                `;
                usersPanel.appendChild(userInfoDiv);

                // User management section (admin only)
                if (state.userRole === 'admin') {
                    const userManagementDiv = document.createElement('div');
                    userManagementDiv.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 mt-6';
                    userManagementDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4 dark:text-white">User Management</h3>
                
                        <!-- Unassigned Users Warning -->
                        <div id="unassigned-users-warning" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 mb-4">
                            <div class="flex">
                                <svg class="w-5 h-5 text-red-400 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-red-800 dark:text-red-200">Users Without Teams</h4>
                                    <p class="text-sm text-red-700 dark:text-red-300 mt-1"><span id="unassigned-count">0</span> user(s) need to be assigned to a team. They are marked with ⚠ below.</p>
                                </div>
                            </div>
                        </div>
                
                        <!-- Security Warning -->
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 mb-4">
                            <div class="flex">
                                <svg class="w-5 h-5 text-yellow-400 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Security Notice</h4>
                                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">Never give admin access to unknown users. All role changes are logged.</p>
                                </div>
                            </div>
                        </div>

                        <div id="users-list" class="space-y-2 mb-4"></div>
                    `;
                    usersPanel.appendChild(userManagementDiv);

                    // Load and display users
                    loadUsers();
                }

                loggedInContainer.appendChild(usersPanel);

                // Players Content Panel (admin only)
                if (state.userRole === 'admin') {
                    const playersPanel = document.createElement('div');
                    playersPanel.id = 'admin-panel-players';
                    playersPanel.className = 'hidden';

                    // Player Sub-sub-tabs
                    const playerSubTabs = document.createElement('div');
                    playerSubTabs.className = 'border-b border-gray-200 dark:border-gray-700 mb-6';
                    playerSubTabs.innerHTML = `
                        <nav class="-mb-px flex space-x-8" aria-label="Player Tabs">
                            <button id="player-tab-roster" class="player-sub-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-emerald-600 border-emerald-500">Roster</button>
                            <button id="player-tab-profiles" class="player-sub-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Profiles</button>
                            <button id="player-tab-archived" class="player-sub-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Archived</button>
                        </nav>
                    `;
                    playersPanel.appendChild(playerSubTabs);

                    // Roster Panel
                    const rosterPanel = document.createElement('div');
                    rosterPanel.id = 'player-panel-roster';
                    rosterPanel.className = 'max-w-2xl';

                    const playerManagementDiv = document.createElement('div');
                    playerManagementDiv.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700';
                    playerManagementDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4 dark:text-white">Add New Player</h3>
                        <div class="space-y-2 mb-6">
                            <input type="text" id="admin-new-player-name" placeholder="Player name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <input type="text" id="admin-new-player-nickname" placeholder="Nickname (optional)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <select id="admin-new-player-team" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">No Team</option>
                                <option value="A">Team A</option>
                                <option value="B">Team B</option>
                            </select>
                            <button id="admin-add-player-btn" class="w-full bg-emerald-600 text-white py-2 px-4 rounded-xl hover:bg-emerald-700 transition-colors duration-200 font-medium">Add Player</button>
                        </div>
                        
                        <h3 class="text-lg font-semibold mb-4 mt-6 dark:text-white">Active Players</h3>
                        <div id="admin-player-roster-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    `;
                    rosterPanel.appendChild(playerManagementDiv);
                    playersPanel.appendChild(rosterPanel);

                    // Profiles Panel
                    const profilesPanel = document.createElement('div');
                    profilesPanel.id = 'player-panel-profiles';
                    profilesPanel.className = 'hidden max-w-2xl';

                    const profileManagementDiv = document.createElement('div');
                    profileManagementDiv.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700';
                    profileManagementDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4 dark:text-white">Player Profiles</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="admin-profile-player-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Player</label>
                                <select id="admin-profile-player-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="">Choose a player...</option>
                                    ${state.players.filter(p => !p.archived).map(p => {
                                        const teamLabel = p.team ? `Team ${p.team}` : 'No Team';
                                        return `<option value="${p.id}">${p.name} (${teamLabel})</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div id="admin-profile-edit-section" class="hidden space-y-4">
                                <div>
                                    <label for="admin-profile-edit-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                                    <input type="text" id="admin-profile-edit-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label for="admin-profile-edit-nickname" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nickname</label>
                                    <input type="text" id="admin-profile-edit-nickname" placeholder="Optional nickname" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label for="admin-profile-edit-team" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Team</label>
                                    <select id="admin-profile-edit-team" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">No Team</option>
                                        <option value="A">Team A</option>
                                        <option value="B">Team B</option>
                                    </select>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="admin-profile-edit-cancel" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-xl">Cancel</button>
                                    <button id="admin-profile-edit-save" class="bg-emerald-600 text-white py-2 px-4 rounded-xl hover:bg-emerald-700 transition-colors">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    `;
                    profilesPanel.appendChild(profileManagementDiv);
                    playersPanel.appendChild(profilesPanel);

                    // Archived Panel
                    const archivedPanel = document.createElement('div');
                    archivedPanel.id = 'player-panel-archived';
                    archivedPanel.className = 'hidden max-w-2xl';

                    const archivedPlayersDiv = document.createElement('div');
                    archivedPlayersDiv.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700';
                    archivedPlayersDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4 dark:text-white">Archived Players</h3>
                        <div id="admin-archived-player-list" class="space-y-2"></div>
                    `;
                    archivedPanel.appendChild(archivedPlayersDiv);
                    playersPanel.appendChild(archivedPanel);

                    loggedInContainer.appendChild(playersPanel);

                    // Function to render archived players
                    const renderArchivedPlayers = () => {
                        const list = document.getElementById('admin-archived-player-list');
                        if (!list) return;

                        list.innerHTML = '';
                        const archivedPlayers = state.players.filter(p => p.archived);

                        if (archivedPlayers.length === 0) {
                            list.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No archived players.</p>';
                            return;
                        }

                        archivedPlayers.forEach(player => {
                            const teamLabel = player.team ? `Team ${player.team}` : 'No Team';
                            const playerEl = document.createElement('div');
                            playerEl.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-lg opacity-75';
                            playerEl.innerHTML = `
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium dark:text-white truncate">${player.name}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${player.nickname || 'No nickname'} • ${teamLabel}</p>
                                </div>
                                <button data-player-id="${player.id}" class="admin-unarchive-player-btn text-emerald-500 hover:text-emerald-700 text-sm font-semibold ml-2">Restore</button>
                            `;
                            list.appendChild(playerEl);
                        });

                        // Add unarchive event listeners
                        document.querySelectorAll('.admin-unarchive-player-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                unarchivePlayer(e.target.dataset.playerId);
                            });
                        });
                    };

                    // Set up player sub-tab switching
                    setTimeout(() => {
                        document.getElementById('player-tab-roster')?.addEventListener('click', () => {
                            document.getElementById('player-panel-roster').classList.remove('hidden');
                            document.getElementById('player-panel-profiles').classList.add('hidden');
                            document.getElementById('player-panel-archived').classList.add('hidden');
                            document.getElementById('player-tab-roster').classList.add('text-emerald-600', 'border-emerald-500');
                            document.getElementById('player-tab-roster').classList.remove('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-profiles').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-profiles').classList.remove('text-emerald-600', 'border-emerald-500');
                            document.getElementById('player-tab-archived').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-archived').classList.remove('text-emerald-600', 'border-emerald-500');
                        });

                        document.getElementById('player-tab-profiles')?.addEventListener('click', () => {
                            document.getElementById('player-panel-profiles').classList.remove('hidden');
                            document.getElementById('player-panel-roster').classList.add('hidden');
                            document.getElementById('player-panel-archived').classList.add('hidden');
                            document.getElementById('player-tab-profiles').classList.add('text-emerald-600', 'border-emerald-500');
                            document.getElementById('player-tab-profiles').classList.remove('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-roster').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-roster').classList.remove('text-emerald-600', 'border-emerald-500');
                            document.getElementById('player-tab-archived').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-archived').classList.remove('text-emerald-600', 'border-emerald-500');
                        });

                        document.getElementById('player-tab-archived')?.addEventListener('click', () => {
                            document.getElementById('player-panel-archived').classList.remove('hidden');
                            document.getElementById('player-panel-roster').classList.add('hidden');
                            document.getElementById('player-panel-profiles').classList.add('hidden');
                            document.getElementById('player-tab-archived').classList.add('text-emerald-600', 'border-emerald-500');
                            document.getElementById('player-tab-archived').classList.remove('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-roster').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-roster').classList.remove('text-emerald-600', 'border-emerald-500');
                            document.getElementById('player-tab-profiles').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('player-tab-profiles').classList.remove('text-emerald-600', 'border-emerald-500');
                            renderArchivedPlayers();
                        });

                        // Profile editing handlers
                        document.getElementById('admin-profile-player-select')?.addEventListener('change', (e) => {
                            const playerId = e.target.value;
                            const editSection = document.getElementById('admin-profile-edit-section');
                            
                            if (playerId) {
                                const player = state.players.find(p => p.id === playerId);
                                if (player) {
                                    document.getElementById('admin-profile-edit-name').value = player.name || '';
                                    document.getElementById('admin-profile-edit-nickname').value = player.nickname || '';
                                    document.getElementById('admin-profile-edit-team').value = player.team || '';
                                    editSection.classList.remove('hidden');
                                }
                            } else {
                                editSection.classList.add('hidden');
                            }
                        });

                        document.getElementById('admin-profile-edit-cancel')?.addEventListener('click', () => {
                            document.getElementById('admin-profile-player-select').value = '';
                            document.getElementById('admin-profile-edit-section').classList.add('hidden');
                        });

                        document.getElementById('admin-profile-edit-save')?.addEventListener('click', async () => {
                            const playerId = document.getElementById('admin-profile-player-select').value;
                            const newName = document.getElementById('admin-profile-edit-name').value.trim();
                            const newNickname = document.getElementById('admin-profile-edit-nickname').value.trim();
                            const newTeam = document.getElementById('admin-profile-edit-team').value || null;

                            if (!playerId) {
                                showToast("Please select a player.", 'warning');
                                return;
                            }

                            if (!newName) {
                                showToast("Player name cannot be empty.", 'warning');
                                return;
                            }

                            try {
                                await safeFirebaseCall('updatePlayerProfile', async () => {
                                    const playerRef = doc(state.db, PLAYERS_COLLECTION, playerId);
                                    return await updateDoc(playerRef, {
                                        name: newName,
                                        nickname: newNickname,
                                        team: newTeam
                                    });
                                });

                                showToast("Player profile updated successfully!");
                                document.getElementById('admin-profile-player-select').value = '';
                                document.getElementById('admin-profile-edit-section').classList.add('hidden');
                                renderAdminPlayerRoster(); // Refresh the roster
                            } catch (error) {
                                if (error.message.includes('Rate limit')) {
                                    showToast(error.message, 'error');
                                } else {
                                    console.error("Error updating player profile:", error);
                                    showToast("Could not update player profile.", 'error');
                                }
                            }
                        });
                    }, 100);

                    // Set up global team filter
                    setTimeout(() => {
                        document.getElementById('admin-team-filter')?.addEventListener('change', () => {
                            loadUsers();
                            renderAdminPlayerRoster();
                        });
                    }, 100);

                    // Set up admin sub-tab switching
                    setTimeout(() => {
                        document.getElementById('admin-tab-users')?.addEventListener('click', () => {
                            document.getElementById('admin-panel-users').classList.remove('hidden');
                            document.getElementById('admin-panel-players').classList.add('hidden');
                            document.getElementById('admin-tab-users').classList.add('text-emerald-600', 'border-emerald-500');
                            document.getElementById('admin-tab-users').classList.remove('text-gray-500', 'border-transparent');
                            document.getElementById('admin-tab-players').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('admin-tab-players').classList.remove('text-emerald-600', 'border-emerald-500');
                        });

                        document.getElementById('admin-tab-players')?.addEventListener('click', () => {
                            document.getElementById('admin-panel-players').classList.remove('hidden');
                            document.getElementById('admin-panel-users').classList.add('hidden');
                            document.getElementById('admin-tab-players').classList.add('text-emerald-600', 'border-emerald-500');
                            document.getElementById('admin-tab-players').classList.remove('text-gray-500', 'border-transparent');
                            document.getElementById('admin-tab-users').classList.add('text-gray-500', 'border-transparent');
                            document.getElementById('admin-tab-users').classList.remove('text-emerald-600', 'border-emerald-500');
                            renderAdminPlayerRoster(); // Render when switching to players tab
                        });

                        // Initial render of player roster
                        renderAdminPlayerRoster();
                    }, 100);
                }
             
                // Sign out button
                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Sign Out';
                logoutBtn.className = 'w-full bg-red-500 text-white py-2 px-4 rounded-xl hover:bg-red-600 transition-colors duration-200 font-medium';
                logoutBtn.addEventListener('click', handleLogout);
                loggedInContainer.appendChild(logoutBtn);

                ui.adminContentArea.appendChild(loggedInContainer);
            } else {
                // Viewer mode content
                const viewerContainer = document.createElement('div');
                viewerContainer.className = 'space-y-4 max-w-sm';
                viewerContainer.innerHTML = `<p class="text-gray-600 dark:text-gray-300">You are currently in View Only mode.</p>`;

                const returnBtn = document.createElement('button');
                returnBtn.textContent = 'Return to Sign In';
                returnBtn.className = 'w-full bg-gray-800 dark:bg-gray-600 text-white py-2 px-4 rounded-xl hover:bg-gray-700 dark:hover:bg-gray-500 transition-colors duration-200 font-medium';
                returnBtn.addEventListener('click', () => {
                    ui.mainApp.classList.add('hidden');
                    ui.roleSelectionOverlay.classList.remove('hidden');
                });

                viewerContainer.appendChild(returnBtn);
                ui.adminContentArea.appendChild(viewerContainer);
            }
        }

        function renderAdminPlayerRoster() {
            const list = document.getElementById('admin-player-roster-list');
            if (!list) return;
        
            list.innerHTML = '';
            
            const teamFilter = document.getElementById('admin-team-filter')?.value || 'all';
            
            // Filter out archived players and apply team filter
            let activePlayers = state.players.filter(p => !p.archived);
            
            if (teamFilter !== 'all') {
                if (teamFilter === 'none') {
                    activePlayers = activePlayers.filter(p => !p.team);
                } else {
                    activePlayers = activePlayers.filter(p => p.team === teamFilter);
                }
            }
            
            if (activePlayers.length === 0) {
                list.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No players in roster.</p>';
                return;
            }
        
            activePlayers.forEach(player => {
                const teamLabel = player.team ? `Team ${player.team}` : 'No Team';
                const playerEl = document.createElement('div');
                playerEl.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-lg';
                playerEl.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-medium dark:text-white truncate">${player.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${player.nickname || 'No nickname'} • ${teamLabel}</p>
                    </div>
                    <button data-player-id="${player.id}" class="admin-archive-player-btn text-orange-500 hover:text-orange-700 text-sm font-semibold ml-2">Archive</button>
                `;
                list.appendChild(playerEl);
            });
            // Show warning if there are temporary players
            const tempPlayers = state.players.filter(p => p.isTemporary);
            if (tempPlayers.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 mb-3';
                warningDiv.innerHTML = `
                    <div class="flex">
                        <svg class="w-5 h-5 text-yellow-400 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Temporary Players</h4>
                            <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">${tempPlayers.length} player(s) were auto-created during match setup. Review and assign teams via "Manage Player Profiles".</p>
                        </div>
                    </div>
                `;
                list.insertBefore(warningDiv, list.firstChild);
            }
            
        
            // Add archive event listeners
            document.querySelectorAll('.admin-archive-player-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    archivePlayer(e.target.dataset.playerId);
                });
            });
        }

        function renderTabs() {
            ui.mobileNavLinks.innerHTML = ''; // Clear previous links
            for (const tabKey in ui.tabs) {
                const tabButton = ui.tabs[tabKey];
                const contentPanel = ui.content[tabKey];

                // Hide admin tab for non-admin users
                if (tabKey === 'admin' && state.userRole !== 'admin') {
                    if (tabButton) {
                        tabButton.style.display = 'none';
                    }
                    // Skip adding to mobile menu
                    continue;
                } else if (tabKey === 'admin' && state.userRole === 'admin') {
                    // Show admin tab for admins
                    if (tabButton) {
                        tabButton.style.display = '';
                    }
                }

                if (tabButton) {
                    if (tabKey === state.activeTab) {
                        tabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                        tabButton.classList.add('border-emerald-500', 'text-emerald-600');
                    } else {
                        tabButton.classList.remove('border-emerald-500', 'text-emerald-600');
                        tabButton.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-200', 'hover:border-gray-300', 'dark:hover:border-gray-500');
                    }
                }

                const mobileLink = document.createElement('a');
                mobileLink.href = '#';
                mobileLink.dataset.tabName = tabKey;
                mobileLink.textContent = tabButton.textContent;
                mobileLink.className = `text-lg p-2 rounded-md ${tabKey === state.activeTab ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300 font-semibold' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                ui.mobileNavLinks.appendChild(mobileLink);
            }
        }

        function renderSeasonManagement() {
            ui.seasonsList.innerHTML = '';
            if (state.seasons.length === 0) {
                ui.seasonsList.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No seasons created yet.</p>`;
                ui.activeSeasonDisplay.textContent = 'N/A - Please create a season.';
            } else {
                let activeSeasonName = 'N/A';
                state.seasons.forEach(season => {
                    const isActive = season.id === state.activeSeasonId;
                    if (isActive) activeSeasonName = season.name;
                    const seasonEl = document.createElement('div');
                    seasonEl.className = `flex items-center justify-between p-2 rounded-lg ${isActive ? 'bg-emerald-100 dark:bg-emerald-900' : 'bg-gray-100 dark:bg-gray-700'}`;
                    seasonEl.innerHTML = `
                        <span class="font-medium dark:text-white">${season.name}</span>
                        ${!isActive && (state.userRole === 'admin' || state.userRole === 'member') ? `<button data-season-id="${season.id}" class="set-active-season-btn text-emerald-600 dark:text-emerald-400 hover:text-emerald-800 dark:hover:text-emerald-300 text-sm font-semibold">Set Active</button>` : ''}
                    `;
                    ui.seasonsList.appendChild(seasonEl);
                });
                ui.activeSeasonDisplay.textContent = activeSeasonName;
            }
            ui.addSeasonForm.classList.toggle('hidden', state.userRole === 'viewer' || state.userRole === 'scorer');
        }

        function renderFixturePlayerSelectors() {
            const form = ui.fixtureForm;
            form.innerHTML = '';
        
            const teamPlayers = state.players.filter(p => p.team === state.userTeam && !p.archived);
        
            GAME_TITLES.forEach((title, i) => {
                const isDoubles = title.includes("Doubles");
                const gameSetupEl = document.createElement('div');
                gameSetupEl.className = 'mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg';
        
                // Get current player selections if there's an active fixture
                const currentGame = state.fixture.games?.[i];
                const currentP1Id = currentGame?.playerIds?.[0] || '';
                const currentP2Id = currentGame?.playerIds?.[1] || '';
                
                // Get player names for current selections
                const currentP1Name = currentP1Id ? (state.players.find(p => p.id === currentP1Id)?.name || '') : '';
                const currentP2Name = currentP2Id ? (state.players.find(p => p.id === currentP2Id)?.name || '') : '';
        
                let selectorsHtml = `
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${title}</label>
                    <div class="grid grid-cols-1 ${isDoubles ? 'sm:grid-cols-2' : ''} gap-2">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="game-${i}-p1-input" 
                                data-game-index="${i}"
                                data-player-slot="p1"
                                placeholder="Select or type player name"
                                value="${currentP1Name}"
                                class="player-selector-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                autocomplete="off">
                            <div id="game-${i}-p1-dropdown" class="player-dropdown hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl shadow-lg max-h-48 overflow-y-auto"></div>
                        </div>
                `;
        
                if (isDoubles) {
                    selectorsHtml += `
                        <div class="relative">
                            <input 
                                type="text" 
                                id="game-${i}-p2-input" 
                                data-game-index="${i}"
                                data-player-slot="p2"
                                placeholder="Select or type player name"
                                value="${currentP2Name}"
                                class="player-selector-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                autocomplete="off">
                            <div id="game-${i}-p2-dropdown" class="player-dropdown hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl shadow-lg max-h-48 overflow-y-auto"></div>
                        </div>
                    `;
                }
        
                selectorsHtml += '</div>';
                gameSetupEl.innerHTML = selectorsHtml;
                form.appendChild(gameSetupEl);
            });
        
            // Set up dropdown functionality
            setupPlayerSelectors();
        }

        function setupPlayerSelectors() {
            const inputs = document.querySelectorAll('.player-selector-input');
            const teamPlayers = state.players.filter(p => p.team === state.userTeam);
        
            inputs.forEach(input => {
                const gameIndex = input.dataset.gameIndex;
                const playerSlot = input.dataset.playerSlot;
                const dropdown = document.getElementById(`game-${gameIndex}-${playerSlot}-dropdown`);
        
                // Show dropdown on focus
                input.addEventListener('focus', () => {
                    showPlayerDropdown(input, dropdown, teamPlayers, '');
                });
        
                // Filter dropdown on input
                input.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    showPlayerDropdown(input, dropdown, teamPlayers, searchTerm);
                });
        
                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        }
        
        function showPlayerDropdown(input, dropdown, players, searchTerm) {
            const filtered = players.filter(p => 
                p.name.toLowerCase().includes(searchTerm) && !p.archived
            );
        
            dropdown.innerHTML = '';
        
            // Show "Add as new player" option if typing custom name
            if (searchTerm && !filtered.find(p => p.name.toLowerCase() === searchTerm)) {
                const customOption = document.createElement('div');
                customOption.className = 'px-3 py-2 hover:bg-emerald-100 dark:hover:bg-emerald-900 cursor-pointer border-b border-gray-200 dark:border-gray-700';
                customOption.innerHTML = `<span class="text-emerald-600 dark:text-emerald-400 font-medium">+ Add "${searchTerm}" as new player</span>`;
                customOption.addEventListener('click', () => {
                    input.value = searchTerm;
                    dropdown.classList.add('hidden');
                });
                dropdown.appendChild(customOption);
            }
        
            // Show existing players
            if (filtered.length > 0) {
                filtered.forEach(player => {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                    option.textContent = player.name;
                    option.addEventListener('click', () => {
                        input.value = player.name;
                        dropdown.classList.add('hidden');
                    });
                    dropdown.appendChild(option);
                });
            } else if (!searchTerm) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'px-3 py-2 text-gray-500 dark:text-gray-400 text-sm';
                emptyMsg.textContent = 'No players available. Type to add new player.';
                dropdown.appendChild(emptyMsg);
            }
        
            dropdown.classList.remove('hidden');
        }
     

        function renderFixtureSetup() {
            const isDisabled = state.userRole === 'viewer' || state.userRole === 'scorer' || (!state.userTeam && state.isLoggedIn && state.userRole !== 'viewer');
            const hasActiveFixture = state.fixture.id !== null;
            
            // Show warning if logged-in user (not viewer) has no team
            if (!state.userTeam && state.isLoggedIn && state.userRole !== 'viewer') {
                ui.oppositionNameInput.disabled = true;
                ui.matchDateInput.disabled = true;
                const warningDiv = document.createElement('div');
                warningDiv.className = 'col-span-2 p-4 rounded-xl bg-yellow-100 dark:bg-yellow-900/30 text-center mb-4';
                warningDiv.innerHTML = `
                    <p class="font-semibold text-yellow-900 dark:text-yellow-100">No Team Assigned</p>
                    <p class="text-sm text-yellow-800 dark:text-yellow-200">Contact an admin to assign you to a team.</p>
                `;
                if (ui.fixtureForm.parentElement && !document.getElementById('no-team-warning')) {
                    warningDiv.id = 'no-team-warning';
                    ui.fixtureForm.parentElement.insertBefore(warningDiv, ui.fixtureForm);
                }
            } else {
                const existingWarning = document.getElementById('no-team-warning');
                if (existingWarning) existingWarning.remove();
            }
            // Disable most inputs for viewers/scorers, but allow editing during active fixture for members/admins
            document.querySelectorAll('#tab-content-setup input:not(#opposition-name-input):not(#match-date-input), #tab-content-setup select').forEach(el => {
                el.disabled = isDisabled;
            });

            // Handle the create button differently - hide when fixture is active, show "Update Teams" instead
            if (hasActiveFixture) {
                ui.createFixtureBtn.style.display = 'none';

                // Add an update button if it doesn't exist
                let updateBtn = document.getElementById('update-teams-btn');
                if (!updateBtn) {
                    updateBtn = document.createElement('button');
                    updateBtn.id = 'update-teams-btn';
                    updateBtn.className = 'w-full bg-blue-600 text-white py-3 px-4 rounded-xl hover:bg-blue-700 transition-colors duration-200 font-semibold text-lg';
                    updateBtn.textContent = 'Update Team Selections';
                    ui.createFixtureBtn.parentNode.insertBefore(updateBtn, ui.createFixtureBtn.nextSibling);

                    updateBtn.addEventListener('click', updateTeamSelections);
                }
                updateBtn.style.display = isDisabled ? 'none' : 'block';

                // Disable opposition name and date during active fixture
                ui.oppositionNameInput.disabled = true;
                ui.matchDateInput.disabled = true;
            } else {
                ui.createFixtureBtn.style.display = 'block';
                const updateBtn = document.getElementById('update-teams-btn');
                if (updateBtn) updateBtn.style.display = 'none';

                // Re-enable opposition name and date when no active fixture
                ui.oppositionNameInput.disabled = isDisabled;
                ui.matchDateInput.disabled = isDisabled;

                if (isDisabled) {
                    ui.createFixtureBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    ui.createFixtureBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function getPlayerStats(player, seasonId, type = 'singles') {
            const defaultStats = { gamesWon: 0, gamesLost: 0, legsWon: 0, legsLost: 0, scores100: 0, scores140: 0, scores180: 0, highCheckout: 0, outstandingFines: 0, totalFines: 0 };
            if (!player || !player.stats) return defaultStats;

            const seasonsToAggregate = seasonId === 'all-time'
                ? Object.values(player.stats)
                : [player.stats[seasonId] || {}];

            const aggregated = {
                singles: { ...defaultStats },
                doubles: { ...defaultStats }
            };

            for (const seasonData of seasonsToAggregate) {
                const isNewFormat = seasonData.hasOwnProperty('singles') || seasonData.hasOwnProperty('doubles');
                const singlesData = isNewFormat ? (seasonData.singles || {}) : seasonData;
                const doublesData = isNewFormat ? (seasonData.doubles || {}) : {};

                // Aggregate stats, but handle highCheckout separately as it's a 'max' not a 'sum'
                for (const key in defaultStats) {
                    if (key !== 'highCheckout') {
                        aggregated.singles[key] += singlesData[key] || 0;
                        aggregated.doubles[key] += doublesData[key] || 0;
                    }
                }
                aggregated.singles.highCheckout = Math.max(aggregated.singles.highCheckout, singlesData.highCheckout || 0);
                aggregated.doubles.highCheckout = Math.max(aggregated.doubles.highCheckout, doublesData.highCheckout || 0);
                // Doubles doesn't have a high checkout in this app's logic, so we don't need to calculate it.
            }

            if (type === 'singles') return aggregated.singles;
            if (type === 'doubles') return aggregated.doubles;
            if (type === 'combined') {
                // For the main leaderboard, we show game/leg stats from singles ONLY,
                // but combine the scoring stats from both singles and doubles.
                return {
                    gamesWon: aggregated.singles.gamesWon,
                    gamesLost: aggregated.singles.gamesLost,
                    legsWon: aggregated.singles.legsWon,
                    legsLost: aggregated.singles.legsLost,
                    scores100: aggregated.singles.scores100 + aggregated.doubles.scores100,
                    scores140: aggregated.singles.scores140 + aggregated.doubles.scores140,
                    scores180: aggregated.singles.scores180 + aggregated.doubles.scores180,
                    highCheckout: aggregated.singles.highCheckout, // H/C is only from singles
                    outstandingFines: aggregated.singles.outstandingFines,
                    totalFines: aggregated.singles.totalFines,
                };
            }
            return defaultStats;
        }


        function renderLeaderboard() {
            ui.seasonFilterSelect.innerHTML = `<option value="all-time">All-Time</option>`;
            state.seasons.forEach(s => {
                ui.seasonFilterSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            ui.seasonFilterSelect.value = state.selectedStatsSeasonId;

           // Update column visibility controls
           document.querySelectorAll('.column-checkbox').forEach(checkbox => {
               checkbox.checked = state.columnVisibility[checkbox.dataset.column];
           });
           
           ui.leaderboardBody.innerHTML = '';
           
           // Get visible columns
           const visibleColumns = Object.keys(state.columnVisibility).filter(col => state.columnVisibility[col]);
           // Filter by team if selected and exclude archived players
           let filteredPlayers = state.players.filter(p => !p.archived);
           if (state.selectedStatsTeamFilter !== 'all') {
               filteredPlayers = filteredPlayers.filter(p => p.team === state.selectedStatsTeamFilter);
           }
           
           let playersWithStats = filteredPlayers.map(p => {
                const singlesStats = getPlayerStats(p, state.selectedStatsSeasonId, 'singles');
                const combinedStats = getPlayerStats(p, state.selectedStatsSeasonId, 'combined');
                const totalLegs = singlesStats.legsWon + singlesStats.legsLost;
                const legWinPercent = totalLegs > 0 ? ((singlesStats.legsWon / totalLegs) * 100) : 0;
                const gamesPlayed = singlesStats.gamesWon + singlesStats.gamesLost;


                const displayStats = {
                    gamesPlayed: gamesPlayed,
                    gamesWon: singlesStats.gamesWon,
                    gamesLost: singlesStats.gamesLost,
                    legsWon: singlesStats.legsWon,
                    legsLost: singlesStats.legsLost,
                    legWinPercent: legWinPercent,
                    scores100: combinedStats.scores100,
                    scores140: combinedStats.scores140,
                    scores180: combinedStats.scores180,
                    highCheckout: combinedStats.highCheckout,
                    totalFines: singlesStats.totalFines,
                };

                return {
                    ...p,
                    displayStats: displayStats
                };
            });

            // Sorting logic
            const { column, direction } = state.leaderboardSort;
            playersWithStats.sort((a, b) => {
                let valA = a.displayStats[column];
                let valB = b.displayStats[column];

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                // As a fallback, sort by games won if the primary sort values are equal
                if (column !== 'gamesWon') {
                    return b.displayStats.gamesWon - a.displayStats.gamesWon;
                }
                return 0;
            });


            // Update table headers visibility
            document.querySelectorAll('#stats-table-header th[data-sort]').forEach(header => {
                const column = header.dataset.sort;
                header.style.display = state.columnVisibility[column] ? '' : 'none';
            });
            
            playersWithStats.forEach(player => {
                const stats = player.displayStats;
                const tr = document.createElement('tr');
                tr.className = 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700';
                tr.dataset.playerId = player.id;
                
                // Player name column (always visible)
                let cellsHTML = `<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${player.name}</td>`;
                
                // Add cells for visible columns only
                const columnData = {
                    gamesPlayed: stats.gamesPlayed,
                    gamesWon: stats.gamesWon,
                    gamesLost: stats.gamesLost,
                    legsWon: stats.legsWon,
                    legsLost: stats.legsLost,
                    legWinPercent: `${stats.legWinPercent.toFixed(0)}%`,
                    scores100: stats.scores100,
                    scores140: stats.scores140,
                    scores180: stats.scores180,
                    highCheckout: stats.highCheckout,
                    totalFines: `£${(stats.totalFines / 100).toFixed(2)}`
                };
                
                Object.keys(columnData).forEach(column => {
                    if (state.columnVisibility[column]) {
                        cellsHTML += `<td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-center">${columnData[column]}</td>`;
                    }
                });
                
                tr.innerHTML = cellsHTML;
                ui.leaderboardBody.appendChild(tr);
            });

            // Update header arrows
            document.querySelectorAll('#stats-table-header th').forEach(th => {
                // Clear existing arrows
                const existingArrow = th.querySelector('.sort-arrow');
                if (existingArrow) {
                    existingArrow.remove();
                }

                // Add arrow to the sorted column
                if (th.dataset.sort === column) {
                    const arrow = document.createElement('span');
                    arrow.className = 'sort-arrow ml-1';
                    arrow.innerHTML = direction === 'desc' ? '▼' : '▲';
                    th.appendChild(arrow);
                }
            });
        }
        function renderOverallScore(container) {
            container.innerHTML = '';
            if (!state.fixture.id) return;

            let burnabyLegs = 0;
            let oppositionLegs = 0;
            state.fixture.games.forEach(game => {
                burnabyLegs += game.legsWon || 0;
                oppositionLegs += game.legsLost || 0;
            });

            const scoreEl = document.createElement('div');
            scoreEl.className = 'p-4 bg-emerald-600 text-white rounded-xl';
            scoreEl.innerHTML = `<h3 class="text-xl sm:text-2xl font-bold text-center">Total Legs: ${burnabyLegs} - ${oppositionLegs}</h3>`;
            container.appendChild(scoreEl);
        }

        function renderCurrentMatch() {
            // Show warning if logged-in user (not viewer) has no team assigned
            if (!state.userTeam && state.isLoggedIn && state.userRole !== 'viewer') {
                ui.currentMatchOpponent.textContent = 'Team Assignment Required';
                ui.currentMatchResults.innerHTML = `
                    <div class="p-6 rounded-xl bg-yellow-100 dark:bg-yellow-900/30 text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <p class="font-semibold text-lg text-yellow-900 dark:text-yellow-100 mb-2">No Team Assigned</p>
                        <p class="text-yellow-800 dark:text-yellow-200">Please contact an admin to assign you to A Team or B Team.</p>
                    </div>
                `;
                ui.currentMatchScoreContainer.innerHTML = '';
                return;
            }
            
            // Filter fixtures by active match view team
            const teamFixtures = state.previousFixtures.filter(f => f.team === state.activeMatchView);
            const activeFixture = teamFixtures.find(f => f.status === 'live');
            
            if (!activeFixture && !state.fixture.id) {
                // Show "No active match" message
                ui.currentMatchOpponent.textContent = 'Live results as they come in.';
               
                
                // Show next upcoming match for the selected team view
                const nextMatch = getNextUpcomingMatch(state.activeMatchView);
                if (nextMatch) {
                    const matchDate = nextMatch.scheduledDate?.toDate ? nextMatch.scheduledDate.toDate() : new Date(nextMatch.scheduledDate);
                    ui.currentMatchResults.innerHTML = `
                        <p class="text-gray-500 dark:text-gray-400 mb-4">No active match.</p>
                        <div class="p-4 rounded-xl bg-blue-100 dark:bg-blue-800/60 text-center">
                            <p class="font-semibold dark:text-white">Next Match</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">vs ${nextMatch.oppositionName}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${matchDate.toLocaleDateString()}</p>
                            ${nextMatch.venue ? `<p class="text-sm text-gray-600 dark:text-gray-400">${nextMatch.venue}</p>` : ''}
                        </div>
                    `;
                } else {
                    ui.currentMatchResults.innerHTML = `
                        <p class="text-gray-500 dark:text-gray-400">No active match.</p>
                        <div class="p-4 rounded-xl bg-blue-100 dark:bg-blue-800/60 text-center">
                         <p class="font-semibold dark:text-white">No Upcoming Matches</p>
                        </div>
                    `;
                }
                ui.currentMatchScoreContainer.innerHTML = '';
                return;
            }
            const displayFixture = activeFixture || state.fixture;
                ui.currentMatchOpponent.textContent = `vs ${displayFixture.oppositionName}`;
                ui.currentMatchResults.innerHTML = '';
            
                renderOverallScore(ui.currentMatchScoreContainer);
            
                displayFixture.games.forEach((game, index) => {
                const gameEl = document.createElement('div');
                gameEl.className = `p-4 rounded-xl ${state.currentGameIndex === index ? 'bg-emerald-100 dark:bg-emerald-800/60' : 'bg-gray-50 dark:bg-gray-700/50'}`;
                const playerNames = game.playerIds.map(id => state.players.find(p => p.id === id)?.name || 'Unknown').join(' & ');
                gameEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold dark:text-white">${game.title}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${playerNames}</p>
                        </div>
                        <p class="text-xl font-bold dark:text-white">${game.legsWon || 0} - ${game.legsLost || 0}</p>
                    </div>
                `;
                ui.currentMatchResults.appendChild(gameEl);
            });
        }

        function renderFixturesTab() {
            // Handle sub-tab styling
            if (state.activeFixturesTab === 'upcoming') {
                ui.fixturesTabUpcoming.classList.add('text-emerald-600', 'border-emerald-500');
                ui.fixturesTabUpcoming.classList.remove('text-gray-500', 'border-transparent');
                ui.fixturesTabPrevious.classList.add('text-gray-500', 'border-transparent');
                ui.fixturesTabPrevious.classList.remove('text-emerald-600', 'border-emerald-500');
                ui.fixturesContentUpcoming.classList.remove('hidden');
                ui.fixturesContentPrevious.classList.add('hidden');
            } else {
                ui.fixturesTabPrevious.classList.add('text-emerald-600', 'border-emerald-500');
                ui.fixturesTabPrevious.classList.remove('text-gray-500', 'border-transparent');
                ui.fixturesTabUpcoming.classList.add('text-gray-500', 'border-transparent');
                ui.fixturesTabUpcoming.classList.remove('text-emerald-600', 'border-emerald-500');
                ui.fixturesContentPrevious.classList.remove('hidden');
                ui.fixturesContentUpcoming.classList.add('hidden');
            }

            renderUpcomingFixtures();
            renderPreviousFixtures();
        }

        function renderUpcomingFixtures() {
            ui.upcomingFixturesList.innerHTML = '';
        
            // Show/hide add button based on permissions
            ui.addFixtureBtn.classList.toggle('hidden', state.userRole === 'viewer' || state.userRole === 'scorer');
        
            const teamFixtures = state.upcomingFixtures.filter(f => f.team === state.activeMatchView);
        
            if (teamFixtures.length === 0) {
                ui.upcomingFixturesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No upcoming matches.</p>';
                return;
            }

            teamFixtures.forEach(fixture => {
                const item = document.createElement('div');
                item.className = `w-full text-left p-3 rounded-lg transition-colors duration-200 ${state.selectedUpcomingFixtureId === fixture.id ? 'bg-emerald-100 dark:bg-emerald-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;

                const isAdmin = state.userRole === 'admin';
                const canStartMatch = state.userRole === 'admin' || state.userRole === 'member';
                const scheduledDate = fixture.scheduledDate?.toDate ? fixture.scheduledDate.toDate() : new Date(fixture.scheduledDate);

                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <button class="flex-grow text-left select-upcoming-match-btn" data-fixture-id="${fixture.id}">
                            <p class="font-semibold dark:text-white">vs ${fixture.oppositionName} ${fixture.location ? `(${fixture.location})` : ''}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${scheduledDate.toLocaleDateString()}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                            ${fixture.venue ? (fixture.address ? `<a href="https://www.google.com/maps/place/${encodeURIComponent(fixture.address)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 underline cursor-pointer" title="View location on Google Maps">${fixture.venue}</a>` : fixture.venue) : 'TBD'}
                            </p>
                        </button>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            ${canStartMatch ? `<button data-fixture-id="${fixture.id}" class="start-match-btn bg-emerald-600 text-white px-3 py-1 rounded text-sm hover:bg-emerald-700">Start Match</button>` : ''}
                            ${isAdmin ? `<button data-fixture-id="${fixture.id}" class="delete-upcoming-fixture-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>` : ''}
                        </div>
                    </div>
                `;
                ui.upcomingFixturesList.appendChild(item);
            });

        }

        function renderPreviousFixtures() {
            ui.previousFixturesList.innerHTML = '';
            const teamFixtures = state.previousFixtures.filter(f => f.team === state.activeMatchView);
            if (teamFixtures.length === 0) {
                ui.previousFixturesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No finished matches.</p>';
                return;
            }

             teamFixtures.forEach(fixture => {
                let burnabyLegs = 0;
                let oppositionLegs = 0;
                fixture.games.forEach(game => {
                    burnabyLegs += game.legsWon || 0;
                    oppositionLegs += game.legsLost || 0;
                });

                const item = document.createElement('div');
                item.className = `w-full text-left p-3 rounded-lg transition-colors duration-200 ${state.selectedPreviousFixtureId === fixture.id ? 'bg-emerald-100 dark:bg-emerald-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;

                const isAdmin = state.userRole === 'admin';
                const matchDate = fixture.scheduledDate?.toDate ? fixture.scheduledDate.toDate() : fixture.createdAt?.toDate();

                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <button class="flex-grow text-left select-previous-match-btn" data-fixture-id="${fixture.id}">
                            <p class="font-semibold dark:text-white">vs ${fixture.oppositionName}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${matchDate?.toLocaleDateString() || 'Unknown date'}</p>
                        </button>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <p class="font-bold text-lg dark:text-white">${burnabyLegs} - ${oppositionLegs}</p>
                            ${isAdmin ? `<button data-fixture-id="${fixture.id}" class="delete-previous-fixture-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>` : ''}
                        </div>
                    </div>
                `;
                ui.previousFixturesList.appendChild(item);
            });

        }

        function renderFines() {
            ui.finesList.innerHTML = '';
            let totalOutstandingFines = 0;
            const teamPlayers = state.players.filter(p => p.team === state.userTeam);
            const playersWithFines = teamPlayers.map(p => {
                const allTimeStats = getPlayerStats(p, 'all-time', 'singles');
                return { ...p, outstandingFines: allTimeStats.outstandingFines };
            }).filter(p => p.outstandingFines > 0);

            playersWithFines.forEach(player => {
                totalOutstandingFines += player.outstandingFines;
                const fineEl = document.createElement('div');
                fineEl.className = 'p-4 flex items-center justify-between';
                fineEl.innerHTML = `
                    <div>
                        <p class="font-semibold dark:text-white">${player.name}</p>
                        <p class="text-lg font-bold text-red-600 dark:text-red-400">£${(player.outstandingFines / 100).toFixed(2)}</p>
                    </div>
                    ${state.userRole === 'admin' ? `<button data-player-id="${player.id}" class="pay-fines-btn bg-emerald-600 text-white py-2 px-4 rounded-xl hover:bg-emerald-700">Mark as Paid</button>` : ''}
                `;
                ui.finesList.appendChild(fineEl);
            });

            if (totalOutstandingFines === 0) {
                ui.finesList.innerHTML = '<p class="p-4 text-gray-500 dark:text-gray-400">No outstanding fines. Good lads.</p>';
                ui.payFineContainer.classList.add('hidden');
            } else {
                ui.payFineContainer.classList.remove('hidden');
            }
        }

        function triggerPlayerChangeAnimation() {
            const el = ui.currentPlayerNames;
            el.classList.remove('animate-pulse');
            void el.offsetWidth;
            el.classList.add('animate-pulse');
        }

        function renderLiveMatch() {
            const isViewer = state.userRole === 'viewer';
            const wrongTeam = state.fixture.team !== state.userTeam;
            const cannotScore = isViewer || wrongTeam;
            document.querySelectorAll('#live-match-content button, #live-match-content input').forEach(el => {
               if(el.id !== 'prev-game-btn' && el.id !== 'next-game-btn') {
                   el.disabled = cannotScore;
               }
            });

            if (!state.fixture.id || !state.fixture.games || state.fixture.games.length === 0) {
                ui.liveMatchContent.classList.add('hidden');
                ui.noFixtureMessage.classList.remove('hidden');
                return;
            }
            ui.liveMatchContent.classList.remove('hidden');
            ui.noFixtureMessage.classList.add('hidden');

            renderOverallScore(ui.liveScoringScoreContainer);

            const game = state.fixture.games[state.currentGameIndex];
            if (!game) {
                console.error("Could not find game data for the current index.");
                return;
            }

            const isDoubles = game.playerIds.length > 1;
            ui.singlesScoringPanel.classList.toggle('hidden', isDoubles);
            ui.doublesScoringPanel.classList.toggle('hidden', !isDoubles);
            ui.finesPanel.classList.toggle('hidden', isDoubles);

            const playerNames = game.playerIds.map(id => {
                const player = state.players.find(p => p.id === id);
                return player?.nickname || player?.name || 'Unknown';
            });
            const namesText = playerNames.join(' & ');
            ui.currentPlayerNames.textContent = namesText;
            const turnSeq = game.turnSeq || 0;
            if (state.lastTurnSeq !== turnSeq) {
                triggerPlayerChangeAnimation();
                state.lastTurnSeq = turnSeq;
            }
            ui.gameNavTitle.textContent = game.title;

            if(isDoubles) {
                ui.doublesPlayerNames.p1.textContent = playerNames[0];
                ui.doublesPlayerNames.p2.textContent = playerNames[1];
            }

            ui.statValueSpans.legsWon.textContent = game.legsWon || 0;
            ui.statValueSpans.legsLost.textContent = game.legsLost || 0;
            ui.statValueSpans.fines.textContent = `£${((game.fines || 0) / 100).toFixed(2)}`;
            // Render individual fines list
            renderCurrentGameFines(game);
            ui.highCheckoutInput.value = game.highCheckout || '';
            if(isDoubles) {
                const p1Input = document.getElementById('p1-high-checkout-input');
                const p2Input = document.getElementById('p2-high-checkout-input');
                if (p1Input) p1Input.value = p1Scores.highCheckout || '';
                if (p2Input) p2Input.value = p2Scores.highCheckout || '';
            }

            const p1Scores = game.playerScores?.[0] || {};
            const p2Scores = game.playerScores?.[1] || {};

            if (isDoubles) {
                ui.statValueSpans.p1_scores100.textContent = p1Scores.scores100 || 0;
                ui.statValueSpans.p1_scores140.textContent = p1Scores.scores140 || 0;
                ui.statValueSpans.p1_scores180.textContent = p1Scores.scores180 || 0;
                ui.statValueSpans.p1_sillyThings.textContent = p1Scores.sillyThings || 0;
                ui.statValueSpans.p2_scores100.textContent = p2Scores.scores100 || 0;
                ui.statValueSpans.p2_scores140.textContent = p2Scores.scores140 || 0;
                ui.statValueSpans.p2_scores180.textContent = p2Scores.scores180 || 0;
                ui.statValueSpans.p2_sillyThings.textContent = p2Scores.sillyThings || 0;
            } else {
                ui.statValueSpans.scores100.textContent = p1Scores.scores100 || 0;
                ui.statValueSpans.scores140.textContent = p1Scores.scores140 || 0;
                ui.statValueSpans.scores180.textContent = p1Scores.scores180 || 0;
                ui.statValueSpans.sillyThings.textContent = p1Scores.sillyThings || 0;
            }

            ui.prevGameBtn.disabled = state.currentGameIndex === 0;
            ui.nextGameBtn.disabled = state.currentGameIndex === state.fixture.games.length - 1;

            const isFinalGame = state.fixture.games && state.fixture.games.length > 0 && state.currentGameIndex === state.fixture.games.length - 1;
            const finishMatchBtn = document.getElementById('finish-match-btn');

            if (isFinalGame && (state.userRole === 'scorer' || state.userRole === 'member' || state.userRole === 'admin')) {
                finishMatchBtn.classList.remove('hidden');
            } else {
                finishMatchBtn.classList.add('hidden');
            }
        }

        function generatePlayerCardHTML(playerId, seasonId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return '<p>Player not found.</p>';

            // Get stats for each game type and a combined total for scores
            const singlesStats = getPlayerStats(player, seasonId, 'singles');
            const doublesStats = getPlayerStats(player, seasonId, 'doubles');
            const combinedScores = getPlayerStats(player, seasonId, 'combined');

            // Calculate win percentages for singles
            const totalLegs = singlesStats.legsWon + singlesStats.legsLost;
            const legWinPercent = totalLegs > 0 ? ((singlesStats.legsWon / totalLegs) * 100).toFixed(0) + '%' : 'N/A';
            const totalGames = singlesStats.gamesWon + singlesStats.gamesLost;
            const gameWinPercent = totalGames > 0 ? ((singlesStats.gamesWon / totalGames) * 100).toFixed(0) + '%' : 'N/A';

            // Generate season selector options
            let optionsHtml = `<option value="all-time">All-Time</option>`;
            state.seasons.forEach(s => {
                optionsHtml += `<option value="${s.id}" ${s.id === seasonId ? 'selected' : ''}>${s.name}</option>`;
            });

            // Find doubles partners for the selected season
            let partners = {};
            state.previousFixtures.forEach(fixture => {
                if (seasonId !== 'all-time' && fixture.seasonId !== seasonId) return;
                fixture.games.forEach(game => {
                    if (game.type === 'doubles' && game.playerIds.includes(player.id)) {
                        const playerIndex = game.playerIds.indexOf(player.id);
                        const partnerId = game.playerIds[1 - playerIndex];
                        const partner = state.players.find(p => p.id === partnerId);
                        if(partner) {
                            partners[partner.name] = (partners[partner.name] || 0) + 1;
                        }
                    }
                });
            });

            const partnersHtml = Object.keys(partners).length > 0
                ? Object.entries(partners).sort((a,b) => b[1] - a[1]).map(([name, count]) => `<span class="bg-gray-200 dark:bg-gray-600 text-sm font-medium px-2 py-1 rounded">${name} (${count})</span>`).join(' ')
                : '<p class="text-sm text-gray-500 dark:text-gray-400">No doubles games played.</p>';

            //console.log('=== DEBUG PLAYER CARD ===');
            //console.log('Player:', player.name);
            //console.log('Season ID:', seasonId);
            //console.log('Raw player stats:', player.stats);
            //console.log('Singles stats:', singlesStats);
            //console.log('Doubles stats:', doublesStats);

            return `
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-4">
                    <h3 class="text-2xl font-bold dark:text-white">${player.name} ${player.nickname ? `"${player.nickname}"` : ''}</h3>
                    <select id="player-card-season-select" class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        ${optionsHtml}
                    </select>
                </div>

                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="profile-tab-singles" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-emerald-600 border-emerald-500">Singles</button>
                        <button id="profile-tab-doubles" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">Doubles</button>
                    </nav>
                </div>

                <!-- Singles Stats Panel -->
                <div id="profile-content-singles" class="mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Games Won</p><p class="text-2xl font-bold dark:text-white">${singlesStats.gamesWon}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Games Lost</p><p class="text-2xl font-bold dark:text-white">${singlesStats.gamesLost}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Legs Won</p><p class="text-2xl font-bold dark:text-white">${singlesStats.legsWon}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Legs Lost</p><p class="text-2xl font-bold dark:text-white">${singlesStats.legsLost}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Game Win %</p><p class="text-2xl font-bold dark:text-white">${gameWinPercent}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Leg Win %</p><p class="text-2xl font-bold dark:text-white">${legWinPercent}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">100+</p><p class="text-2xl font-bold dark:text-white">${combinedScores.scores100}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">140+</p><p class="text-2xl font-bold dark:text-white">${combinedScores.scores140}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">180s</p><p class="text-2xl font-bold dark:text-white">${combinedScores.scores180}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">High Checkout</p><p class="text-2xl font-bold dark:text-white">${singlesStats.highCheckout}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Outstanding Fines</p><p class="text-2xl font-bold text-red-600 dark:text-red-400">£${(singlesStats.outstandingFines / 100).toFixed(2)}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Total Fines</p><p class="text-2xl font-bold text-red-600 dark:text-red-400">£${(singlesStats.totalFines / 100).toFixed(2)}</p></div>
                    </div>
                </div>

                <!-- Doubles Stats Panel -->
                <div id="profile-content-doubles" class="hidden mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Games Won</p><p class="text-2xl font-bold dark:text-white">${doublesStats.gamesWon}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Games Lost</p><p class="text-2xl font-bold dark:text-white">${doublesStats.gamesLost}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Legs Won</p><p class="text-2xl font-bold dark:text-white">${doublesStats.legsWon}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">Legs Lost</p><p class="text-2xl font-bold dark:text-white">${doublesStats.legsLost}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">100+</p><p class="text-2xl font-bold dark:text-white">${doublesStats.scores100}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">140+</p><p class="text-2xl font-bold dark:text-white">${doublesStats.scores140}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">180s</p><p class="text-2xl font-bold dark:text-white">${doublesStats.scores180}</p></div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl text-center flex flex-col justify-center"><p class="text-sm text-gray-600 dark:text-gray-300">High Checkout</p><p class="text-2xl font-bold dark:text-white">${doublesStats.highCheckout}</p></div>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold dark:text-white mb-2">Partners:</h4>
                        <div class="flex flex-wrap gap-2">${partnersHtml}</div>
                    </div>
                </div>
            `;
        }
        function renderCurrentGameFines(game) {
            if (!ui.finesListCurrentGame) return;

            ui.finesListCurrentGame.innerHTML = '';

            if (!game.finesList || game.finesList.length === 0) {
                ui.finesListCurrentGame.innerHTML = '<p class="text-center text-sm text-gray-500 dark:text-gray-400">No fines this game</p>';
                return;
            }

            // Group fines by category
            const fineGroups = {
                'Score of 26': [],
                'Missed Board': [],
                'Low Scores': []
            };

            game.finesList.forEach(fine => {
                if (fine.reason === 'Score of 26') {
                    fineGroups['Score of 26'].push(fine);
                } else if (fine.reason === 'Missed Board') {
                    fineGroups['Missed Board'].push(fine);
                } else if (fine.reason.startsWith('Score of ')) {
                    fineGroups['Low Scores'].push(fine);
                }
            });

            // Render each group that has fines
            Object.entries(fineGroups).forEach(([groupName, fines]) => {
                if (fines.length === 0) return;

                // Group header
                const headerEl = document.createElement('div');
                headerEl.className = 'text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-1 mt-2 first:mt-0';

                const groupTotal = fines.reduce((sum, fine) => sum + fine.amount, 0);
                const count = fines.length;

                headerEl.innerHTML = `${groupName} (${count}) - £${(groupTotal/100).toFixed(2)}`;
                ui.finesListCurrentGame.appendChild(headerEl);

                // Individual fines in this group
                fines.forEach(fine => {
                    const fineEl = document.createElement('div');
                    fineEl.className = 'flex items-center justify-between bg-red-50 dark:bg-red-900/20 p-2 rounded-lg text-sm mb-1';

                    // For low scores, show the actual score; for others, show count
                    let displayText = fine.reason;
                    if (groupName === 'Low Scores') {
                        displayText = fine.reason; // "Score of 3", "Score of 7", etc.
                    } else {
                        displayText = `${groupName}`; // Just "Score of 26" or "Missed Board"
                    }

                    fineEl.innerHTML = `
                        <span class="text-red-700 dark:text-red-300">${displayText}</span>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-600 dark:text-red-400">£${(fine.amount/100).toFixed(2)}</span>
                            ${state.userRole !== 'viewer' ? `<button data-fine-id="${fine.id}" class="remove-fine-btn text-red-500 hover:text-red-700 text-xs bg-white dark:bg-gray-700 px-2 py-1 rounded border">✕</button>` : ''}
                        </div>
                    `;
                    ui.finesListCurrentGame.appendChild(fineEl);
                });
            });
        }

        function renderPlayerCard() {
            if (!state.playerCard.isOpen) {
                ui.playerCardModal.overlay.classList.add('hidden');
                ui.playerCardModal.overlay.classList.remove('flex');
                document.body.classList.remove('modal-open');
                return;
            }
        
            ui.playerCardModal.content.innerHTML = generatePlayerCardHTML(state.playerCard.playerId, state.playerCard.selectedSeasonId);
        
            ui.playerCardModal.overlay.classList.remove('hidden');
            ui.playerCardModal.overlay.classList.add('flex');
            document.body.classList.add('modal-open');

            // Set up tab switching for the player card modal
            setupProfileTabs(ui.playerCardModal.content);
        }

        function openFixtureModal(fixtureId, type) {
            const fixture = type === 'upcoming'
                ? state.upcomingFixtures.find(f => f.id === fixtureId)
                : state.previousFixtures.find(f => f.id === fixtureId);

            if (!fixture) return;

            const scheduledDate = fixture.scheduledDate?.toDate ? fixture.scheduledDate.toDate() : new Date(fixture.scheduledDate);

            let modalContent = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold dark:text-white">vs ${fixture.oppositionName}</h3>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Date</p>
                            <p class="font-semibold dark:text-white">${scheduledDate.toLocaleDateString()}</p>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Season</p>
                            <p class="font-semibold dark:text-white">${state.seasons.find(s => s.id === fixture.seasonId)?.name || 'Unknown'}</p>
                        </div>
                    </div>
            `;

            if (fixture.venue || fixture.location) {
                modalContent += `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Venue</p>
                        <p class="font-semibold dark:text-white">
                            ${fixture.venue ? (fixture.address ? `<a href="https://www.google.com/maps/place/${encodeURIComponent(fixture.address)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 underline cursor-pointer" title="View location on Google Maps">${fixture.venue}</a>` : fixture.venue) : 'TBD'}
                            ${fixture.location ? `(${fixture.location})` : ''}
                        </p>
                    </div>
                `;
            }

            if (type === 'previous') {
                // Show match results for finished games
                let burnabyLegs = 0;
                let oppositionLegs = 0;
                fixture.games.forEach(game => {
                    burnabyLegs += game.legsWon || 0;
                    oppositionLegs += game.legsLost || 0;
                });

                modalContent += `
                    <div class="p-3 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Final Score</p>
                        <p class="font-bold text-xl dark:text-white">${burnabyLegs} - ${oppositionLegs}</p>
                    </div>
                    <div class="space-y-2">
                        <h4 class="font-semibold dark:text-white">Game Results</h4>
                `;

                fixture.games.forEach(game => {
                    const playerNames = game.playerIds.map(id => state.players.find(p => p.id === id)?.name || 'Unknown').join(' & ');
                    modalContent += `
                        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                            <div>
                                <p class="font-medium dark:text-white">${game.title}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${playerNames}</p>
                            </div>
                            <p class="font-bold dark:text-white">${game.legsWon} - ${game.legsLost}</p>
                        </div>
                    `;
                });
                modalContent += '</div>';
            }

            modalContent += '</div>';

            ui.playerCardModal.content.innerHTML = modalContent;
            ui.playerCardModal.overlay.classList.remove('hidden');
            ui.playerCardModal.overlay.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function closeFixtureModal() {
            ui.playerCardModal.overlay.classList.add('hidden');
            ui.playerCardModal.overlay.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        // Haptic feedback utility
        function triggerHaptic(pattern = 'light') {
            if (!('vibrate' in navigator)) return;

            const patterns = {
                light: 10,      // Light tap
                medium: 25,     // Medium tap
                heavy: 50,      // Heavy tap
                double: [20, 50, 20], // Double tap
                success: [20, 100, 30], // Success pattern
                error: [100, 30, 100, 30, 100], // Error pattern
                warning: [30, 20, 30] // Warning pattern
            };

            navigator.vibrate(patterns[pattern] || patterns.light);
        }

        function showToast(message, type = 'success') {
            if (typeof type === 'boolean') type = type ? 'error' : 'success';
            ui.toast.message.textContent = message;

            const configs = {
                success: {
                    color: 'bg-emerald-500',
                    icon: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
                },
                error: {
                    color: 'bg-red-500',
                    icon: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
                },
                warning: {
                    color: 'bg-yellow-500',
                    icon: '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                }
            };

            const { color, icon } = configs[type] || configs.success;

            // Add haptic feedback based on toast type
            if (type === 'success') triggerHaptic('success');
            else if (type === 'error') triggerHaptic('error');
            else if (type === 'warning') triggerHaptic('warning');

            ui.toast.element.classList.remove('bg-emerald-500', 'bg-red-500', 'bg-yellow-500');
            ui.toast.element.classList.add(color);
            ui.toast.icon.innerHTML = icon;

            // Show the toast
            ui.toast.element.classList.remove('toast-hidden');
            ui.toast.element.classList.add('toast-visible');

            // Hide after 3 seconds
            setTimeout(() => {
                ui.toast.element.classList.remove('toast-visible');
                ui.toast.element.classList.add('toast-hidden');
            }, 3000);
        }


        async function handleGoogleSignIn() {
            // Prevent multiple simultaneous sign-in attempts
            if (state.signingIn) return;
            state.signingIn = true;

            const loadingOverlay = document.getElementById('loading-overlay');
            const signInBtn = document.getElementById('google-signin-btn');
            const signInText = document.getElementById('signin-btn-text');

            loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            loadingOverlay.classList.add('opacity-100');
            signInBtn.disabled = true;
            signInText.textContent = 'Signing in...';
            signInBtn.classList.add('opacity-75', 'cursor-not-allowed');

               try {
               const result = await signInWithPopup(state.auth, provider);
               const user = result.user;
               const email = user.email;
               
               // Check if user already has a role assigned in Firestore
               const userDoc = await getDoc(doc(state.db, 'users', user.uid));
               
               if (userDoc.exists()) {
                   // Existing user - use their assigned role and player link
                   const userData = userDoc.data();
                   state.userRole = userData.role || 'viewer'; // Default to member
                   state.userPlayerId = userData.playerId || null; // Get linked player ID
               } else {
                   // New user - default to member role and create user document
                   state.userRole = 'viewer';
                   state.userPlayerId = null;
                   // Use displayName if available, otherwise use email prefix
                   const userName = user.displayName || email.split('@')[0] || 'New User';
                   await setDoc(doc(state.db, 'users', user.uid), {
                       email: email,
                       name: userName,
                       role: 'viewer',
                       playerId: null,
                       team:null,
                       createdAt: serverTimestamp()
                   });
               }

                await handleSuccessfulSignIn(user);

            } catch (error) {
                console.error('Google Sign-In error:', error);
                // Hide loading on error
                loadingOverlay.classList.remove('opacity-100');
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                signInBtn.disabled = false;
                signInText.textContent = 'Sign in with Google';
                signInBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled.', 'warning');
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showToast('Sign-in already in progress.', 'warning');
                } else {
                    showToast('Sign-in failed. Please try again.', 'error');
                }
            } finally {
                state.signingIn = false;
            }
        }

        async function handleHeaderButtonClick() {
            if (state.isLoggedIn) {
                // Sign out functionality
                try {
                    await firebaseSignOut(state.auth);
                } catch (error) {
                    console.error('Sign-out error:', error);
                }

                if (state.logoutTimer) {
                    clearTimeout(state.logoutTimer);
                    state.logoutTimer = null;
                }

                state.isLoggedIn = false;
                state.userRole = null;
                state.userEmail = null;
                state.userName = null;
                state.userPlayerId = null;
                state.signingIn = false; // Reset signing in state

                localStorage.removeItem('userRole');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('loginTimestamp');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userId');
                resetSignInButtonState();
                showToast('You have been logged out.');
                ui.mainApp.classList.add('hidden');
                ui.roleSelectionOverlay.classList.remove('hidden');
                render();
            } else if (state.userRole === 'viewer') {
                // Sign in functionality - go back to login screen
                state.userRole = null;
                state.signingIn = false; // Reset signing in state
                localStorage.removeItem('userRole');
                resetSignInButtonState();
                ui.mainApp.classList.add('hidden');
                ui.roleSelectionOverlay.classList.remove('hidden');
                render();
            }
        }
        async function handleLogout() {
            return handleHeaderButtonClick();
        }

        async function handleEmailSignIn() {
            if (state.signingIn) return;
            state.signingIn = true;

            const loadingOverlay = document.getElementById('loading-overlay');
            const signInBtn = document.getElementById('email-signin-btn');

            loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            loadingOverlay.classList.add('opacity-100');
            signInBtn.disabled = true;
            signInBtn.textContent = 'Signing in...';

            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showToast('Please enter both email and password.', 'warning');
                resetEmailSignInState();
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(state.auth, email, password);
                await handleSuccessfulSignIn(userCredential.user);
            } catch (error) {
                console.error('Email Sign-In error:', error);
                if (error.code === 'auth/user-not-found') {
                    showToast('No account found with this email.', 'error');
                } else if (error.code === 'auth/wrong-password') {
                    showToast('Incorrect password.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showToast('Invalid email address.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showToast('Too many failed attempts. Please try again later.', 'error');
                } else {
                    showToast('Sign-in failed. Please try again.', 'error');
                }
                resetEmailSignInState();
            }
        }

        function openSignupModal() {
            document.getElementById('signup-modal').classList.remove('hidden');
            document.getElementById('signup-modal').classList.add('flex');
            document.getElementById('signup-name').focus();
            document.body.classList.add('modal-open');
        }

        function closeSignupModal() {
            document.getElementById('signup-modal').classList.add('hidden');
            document.getElementById('signup-modal').classList.remove('flex');
            // Clear form
            document.getElementById('signup-name').value = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';
            document.getElementById('signup-confirm-password').value = '';
            document.body.classList.remove('modal-open');
        }

        async function handleEmailSignUp() {
            if (state.signingIn) return;
            state.signingIn = true;

            const loadingOverlay = document.getElementById('loading-overlay');
            const signUpBtn = document.getElementById('signup-modal-submit');

            signUpBtn.disabled = true;
            signUpBtn.textContent = 'Creating account...';

            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;

            if (!name || !email || !password || !confirmPassword) {
                showToast('Please fill in all fields.', 'warning');
                resetEmailSignUpState();
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match.', 'warning');
                resetEmailSignUpState();
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters.', 'warning');
                resetEmailSignUpState();
                return;
            }

            loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            loadingOverlay.classList.add('opacity-100');

            try {
                const userCredential = await createUserWithEmailAndPassword(state.auth, email, password);
                await updateProfile(userCredential.user, { name: name });
                await handleSuccessfulSignIn(userCredential.user);
                closeSignupModal();
                showToast('Account created successfully!');
            } catch (error) {
                console.error('Email Sign-Up error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('An account with this email already exists.', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showToast('Password is too weak.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showToast('Invalid email address.', 'error');
                } else {
                    showToast('Account creation failed. Please try again.', 'error');
                }
                loadingOverlay.classList.remove('opacity-100');
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                resetEmailSignUpState();
            }
        }

        async function handleSuccessfulSignIn(user) {
            const email = user.email;
            const userDoc = await getDoc(doc(state.db, 'users', user.uid));

            if (userDoc.exists()) {
                const userData = userDoc.data();
                state.userRole = userData.role || 'viewer';
                state.userPlayerId = userData.playerId || null;
                state.userTeam = userData.team || null;
                state.activeMatchView = userData.team || null; 
                state.userName = userData.name; // Get name from Firestore
                console.log('Retrieved name from Firestore:', userData.name); // Debug log
            } else {
                state.userRole = 'viewer';
                state.userPlayerId = null;
                state.userName = user.displayName || 'New User';
                await setDoc(doc(state.db, 'users', user.uid), {
                    email: email,
                    name: state.userName,
                    role: 'viewer',
                    playerId: null,
                    createdAt: serverTimestamp()
                });
            }

            state.isLoggedIn = true;
            state.userEmail = email;
            state.userId = user.uid;

            localStorage.setItem('userRole', state.userRole);
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('loginTimestamp', Date.now().toString());
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userId', user.uid);

            startLogoutTimer();

            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.classList.remove('opacity-100');
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                ui.roleSelectionOverlay.classList.add('hidden');
                ui.mainApp.classList.remove('hidden');
                showToast(`Welcome ${state.userName}!`);
                render();
            }, 500);
        }

        function resetEmailSignInState() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const signInBtn = document.getElementById('email-signin-btn');

            loadingOverlay.classList.remove('opacity-100');
            loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            signInBtn.disabled = false;
            signInBtn.textContent = 'Sign In with Email';
            state.signingIn = false;
        }

        function resetEmailSignUpState() {
            const signUpBtn = document.getElementById('signup-modal-submit');
            signUpBtn.disabled = false;
            signUpBtn.textContent = 'Create Account';
            state.signingIn = false;
        }
        function startLogoutTimer(duration = SESSION_DURATION_MS) {
            if (state.logoutTimer) {
                clearTimeout(state.logoutTimer);
            }
            state.logoutTimer = setTimeout(handleLogout, duration);
        }

        function resetSignInButtonState() {
            const signInBtn = document.getElementById('google-signin-btn');
            const signInText = document.getElementById('signin-btn-text');
            const emailSignInBtn = document.getElementById('email-signin-btn');
            const loadingOverlay = document.getElementById('loading-overlay');

            if (signInBtn && signInText) {
                signInBtn.disabled = false;
                signInText.textContent = 'Sign in with Google';
                signInBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }

            if (emailSignInBtn) {
                emailSignInBtn.disabled = false;
                emailSignInBtn.textContent = 'Sign In with Email';
            }

            if (loadingOverlay) {
                loadingOverlay.classList.remove('opacity-100');
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            }

            // Reset global signing in state
            state.signingIn = false;
        }
        async function loadUsers() {
            if (!state.db) return;
            const usersCollection = collection(state.db, 'users');
            onSnapshot(usersCollection, (snapshot) => {
                const usersList = document.getElementById('users-list');
                if (!usersList) return;
        
                usersList.innerHTML = '';
                
                let unassignedCount = 0;
                const teamFilter = document.getElementById('admin-team-filter')?.value || 'all';
        
                snapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    
                    // Apply team filter
                    if (teamFilter !== 'all') {
                        if (teamFilter === 'none' && userData.team) return;
                        if (teamFilter === 'A' && userData.team !== 'A') return;
                        if (teamFilter === 'B' && userData.team !== 'B') return;
                    }
                    const userItem = document.createElement('div');
                    userItem.className = 'flex flex-col sm:flex-row sm:items-center justify-between bg-gray-100 dark:bg-gray-600 p-3 rounded-lg space-y-2 sm:space-y-0';
                    const hasTeam = userData.team === 'A' || userData.team === 'B';
                    userItem.innerHTML = `
                        <div class="min-w-0 flex-1">
                            <p class="font-medium dark:text-white truncate">${userData.name || userData.email} ${!hasTeam ? '<span class="text-yellow-600 dark:text-yellow-400">⚠</span>' : ''}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${userData.email}</p>
                            ${!hasTeam ? '<p class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">No team assigned</p>' : ''}
                        </div>
                        <div class="flex flex-col sm:flex-row items-end sm:items-center gap-2 mt-2 sm:mt-0 w-full sm:w-auto">
                            <select data-user-id="${doc.id}" class="user-team-select w-full sm:w-auto px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-xs sm:text-sm">
                                <option value="">No Team</option>
                                <option value="A" ${userData.team === 'A' ? 'selected' : ''}>A Team</option>
                                <option value="B" ${userData.team === 'B' ? 'selected' : ''}>B Team</option>
                            </select>
                            <select data-user-id="${doc.id}" class="user-role-select w-full sm:w-auto px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-xs sm:text-sm">
                                <option value="viewer" ${userData.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="scorer" ${userData.role === 'scorer' ? 'selected' : ''}>Scorer</option>
                                <option value="member" ${userData.role === 'member' ? 'selected' : ''}>Member</option>
                                <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                            <select data-user-id="${doc.id}" class="user-player-select w-full sm:w-auto px-2 py-1 border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-xs sm:text-sm">
                                <option value="">No Player</option>
                                ${state.players.map(p => `<option value="${p.id}" ${userData.playerId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                    usersList.appendChild(userItem);
            
                    // Count unassigned users
                    if (!hasTeam) {
                        unassignedCount++;
                    }
                });

                // Show/hide unassigned warning
                const warning = document.getElementById('unassigned-users-warning');
                const countSpan = document.getElementById('unassigned-count');
                if (warning && countSpan) {
                    if (unassignedCount > 0) {
                        warning.classList.remove('hidden');
                        countSpan.textContent = unassignedCount;
                    } else {
                        warning.classList.add('hidden');
                    }
                }

                // Add event listeners for team, role and player changes
                document.querySelectorAll('.user-team-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const userId = e.target.dataset.userId;
                        const newTeam = e.target.value || null;
                        await updateUserTeam(userId, newTeam);
                    });
                });
                
                document.querySelectorAll('.user-role-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const userId = e.target.dataset.userId;
                        const newRole = e.target.value;
                        await updateUserRole(userId, newRole);
                    });
                });

                document.querySelectorAll('.user-player-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const userId = e.target.dataset.userId;
                        const newPlayerId = e.target.value || null;
                        await updateUserPlayer(userId, newPlayerId);
                    });
                });

                // Team filter is now handled globally in admin tab setup
            });
        }

        async function updateUserTeam(userId, newTeam) {
            try {
                const targetUserDoc = await getDoc(doc(state.db, 'users', userId));
                const targetUserData = targetUserDoc.exists() ? targetUserDoc.data() : {};
        
                await safeFirebaseCall('auditLog', async () => {
                    return await addDoc(collection(state.db, 'audit_logs'), {
                        action: 'team_change',
                        targetUserId: userId,
                        targetUserName: targetUserData.name || 'Unknown',
                        targetUserEmail: targetUserData.email || 'Unknown',
                        oldTeam: targetUserData.team || null,
                        newTeam: newTeam,
                        adminUserId: state.userId,
                        adminUserName: state.userName || 'Unknown',
                        adminEmail: state.userEmail,
                        timestamp: serverTimestamp(),
                        userAgent: navigator.userAgent
                    });
                });
        
                await safeFirebaseCall('updateUserTeam', async () => {
                    return await updateDoc(doc(state.db, 'users', userId), {
                        team: newTeam,
                        updatedAt: serverTimestamp()
                    });
                });
        
                // If user has a linked player, update that player's team too
                if (targetUserData.playerId) {
                    await safeFirebaseCall('updatePlayerTeam', async () => {
                        return await updateDoc(doc(state.db, PLAYERS_COLLECTION, targetUserData.playerId), {
                            team: newTeam
                        });
                    });
                }
        
                // If updating current user's team, update local state
                if (userId === state.userId) {
                    state.userTeam = newTeam;
                    state.activeMatchView = newTeam || 'A'; // Update active view to match new team
                    localStorage.setItem('userTeam', newTeam || '');
                    render();
                }
        
                showToast('User team updated successfully.');
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error('Error updating user team:', error);
                    showToast('Failed to update user team.', 'error');
                }
            }
        }

        async function updateUserRole(userId, newRole) {
            try {
                // Get the target user's document to capture their name and old role
                const targetUserDoc = await getDoc(doc(state.db, 'users', userId));
                const targetUserData = targetUserDoc.exists() ? targetUserDoc.data() : {};

                // Add enhanced audit logging
                await safeFirebaseCall('auditLog', async () => {
                    return await addDoc(collection(state.db, 'audit_logs'), {
                        action: 'role_change',
                        targetUserId: userId,
                        targetUserName: targetUserData.name || 'Unknown',
                        targetUserEmail: targetUserData.email || 'Unknown',
                        oldRole: targetUserData.role || 'unknown',
                        newRole: newRole,
                        adminUserId: state.userId,
                        adminUserName: state.userName || 'Unknown',
                        adminEmail: state.userEmail,
                        timestamp: serverTimestamp(),
                        userAgent: navigator.userAgent
                    });
                });

                await safeFirebaseCall('updateUserRole', async () => {
                    return await updateDoc(doc(state.db, 'users', userId), {
                        role: newRole,
                        updatedAt: serverTimestamp()
                    });
                });

                // If updating current user's role, update local state
                if (userId === state.userId) {
                    state.userRole = newRole;
                    localStorage.setItem('userRole', newRole);
                    render();
                }

                showToast('User role updated successfully.');
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error('Error updating user role:', error);
                    showToast('Failed to update user role.', 'error');
                }
            }
        }
        async function updateUserPlayer(userId, newPlayerId) {
            try {
                // Get the target user's document and player information
                const targetUserDoc = await getDoc(doc(state.db, 'users', userId));
                const targetUserData = targetUserDoc.exists() ? targetUserDoc.data() : {};
        
                const oldPlayer = state.players.find(p => p.id === targetUserData.playerId);
                const newPlayer = newPlayerId ? state.players.find(p => p.id === newPlayerId) : null;
        
                // Add enhanced audit logging for player links
                await safeFirebaseCall('auditLog', async () => {
                    return await addDoc(collection(state.db, 'audit_logs'), {
                        action: 'player_link_change',
                        targetUserId: userId,
                        targetUserName: targetUserData.name || 'Unknown',
                        targetUserEmail: targetUserData.email || 'Unknown',
                        oldPlayerId: targetUserData.playerId || null,
                        oldPlayerName: oldPlayer?.name || null,
                        newPlayerId: newPlayerId,
                        newPlayerName: newPlayer?.name || null,
                        adminUserId: state.userId,
                        adminUserName: state.userName || 'Unknown',
                        adminEmail: state.userEmail,
                        timestamp: serverTimestamp(),
                        userAgent: navigator.userAgent
                    });
                });
        
        
                await safeFirebaseCall('updateUserPlayer', async () => {
                    return await updateDoc(doc(state.db, 'users', userId), {
                        playerId: newPlayerId,
                        updatedAt: serverTimestamp()
                    });
                });
        
                // Update the new player's team to match the user's team
                if (newPlayerId && targetUserData.team) {
                    await safeFirebaseCall('updatePlayerTeam', async () => {
                        return await updateDoc(doc(state.db, PLAYERS_COLLECTION, newPlayerId), {
                            team: targetUserData.team
                        });
                    });
                }
        
                // If updating current user's player link, update local state
                if (userId === state.userId) {
                    state.userPlayerId = newPlayerId;
                    render();
                }
        
                showToast('User player link updated successfully.');
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error('Error updating user player link:', error);
                    showToast('Failed to update user player link.', 'error');
                }
            }
        }



        function openConfirmModal(title, text, action, data) {
            state.confirmation = { action, data };
            ui.confirmModal.title.textContent = title;
            ui.confirmModal.text.textContent = text;
            ui.confirmModal.overlay.classList.remove('hidden');
            ui.confirmModal.overlay.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function closeConfirmModal() {
            state.confirmation = { action: null, data: null };
            ui.confirmModal.overlay.classList.add('hidden');
            ui.confirmModal.overlay.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function handleConfirmation() {
            const { action, data } = state.confirmation;
            if (action === 'deleteFixture' || action === 'deleteUpcomingFixture' || action === 'deletePreviousFixture') {
                 try {
                    const fixtureIdToDelete = data;
                    await deleteDoc(doc(state.db, FIXTURES_COLLECTION, fixtureIdToDelete));
                    if (state.selectedPreviousFixtureId === fixtureIdToDelete) {
                        state.selectedPreviousFixtureId = null;
                    }
                    if (state.selectedUpcomingFixtureId === fixtureIdToDelete) {
                        state.selectedUpcomingFixtureId = null;
                    }
                    showToast("Fixture deleted successfully.");
                    render();
                } catch (error) {
                    console.error("Error deleting fixture:", error);
                    showToast("Could not delete the fixture.", 'error');
                }
            } else if (action === 'clearPlayerFines') {
                try {
                    await markFinesAsPaid(data);
                    showToast("Fines cleared for player.", 'success');
                } catch (error) {
                    console.error("Error clearing fines:", error);
                    showToast("Could not clear fines.", 'error');
                }
            }
            closeConfirmModal();
        }
        function openMobileMenu() {
            ui.mobileMenuOverlay.classList.remove('hidden');
            setTimeout(() => {
                ui.mobileMenuOverlay.classList.remove('opacity-0');
                ui.mobileMenuOverlay.querySelector('#mobile-menu').classList.remove('translate-x-full');
            }, 10);
        }

        function closeMobileMenu() {
            ui.mobileMenuOverlay.classList.add('opacity-0');
            ui.mobileMenuOverlay.querySelector('#mobile-menu').classList.add('translate-x-full');
            setTimeout(() => {
                ui.mobileMenuOverlay.classList.add('hidden');
            }, 300);
        }

        function switchTab(tabName) {
            // Prevent non-admins from accessing admin tab
            if (tabName === 'admin' && state.userRole !== 'admin') {
                showToast("Access denied. Admin privileges required.", 'error');
                return;
            }

            if (tabName === state.activeTab) {
                closeMobileMenu();
                return;
            }

            const currentTab = state.activeTab;
            const currentPanel = ui.content[currentTab];
            const newPanel = ui.content[tabName];

            triggerHaptic('light');
            state.activeTab = tabName;
            render();

            if (currentPanel && newPanel) {
                currentPanel.classList.add('tab-leave', 'absolute', 'w-full');
                currentPanel.addEventListener('animationend', () => {
                    currentPanel.classList.add('hidden');
                    currentPanel.classList.remove('tab-leave', 'absolute', 'w-full');
                }, { once: true });

                newPanel.classList.remove('hidden');
                newPanel.classList.add('tab-enter');
                newPanel.addEventListener('animationend', () => {
                    newPanel.classList.remove('tab-enter');
                }, { once: true });
            } else {
                if (newPanel) newPanel.classList.remove('hidden');
                if (currentPanel && currentPanel !== newPanel) currentPanel.classList.add('hidden');
            }

            closeMobileMenu();
        }
        async function addPlayer() {
            const nameInput = document.getElementById('admin-new-player-name');
            const nicknameInput = document.getElementById('admin-new-player-nickname');
            const teamSelect = document.getElementById('admin-new-player-team');
        
            if (!nameInput) return; // Not in admin tab
        
            try {
                const name = validateInput(nameInput.value, 50);
                const nickname = validateInput(nicknameInput.value, 50);
                const team = teamSelect.value || null;
        
                if (!name) {
                    showToast("Player name cannot be empty.", 'error');
                    return;
                }
        
                await safeFirebaseCall('addPlayer', async () => {
                    return await addDoc(collection(state.db, PLAYERS_COLLECTION), {
                        name: name,
                        nickname: nickname,
                        team: team,
                        stats: {}
                    });
                });
        
                showToast(`${name} added to the roster.`);
                nameInput.value = '';
                nicknameInput.value = '';
                teamSelect.value = '';
            } catch (error) {
                if (error.message.includes('Invalid characters') || error.message.includes('Input too long')) {
                    showToast(error.message, 'error');
                } else if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error adding player: ", error);
                    showToast("Could not add player.", 'error');
                }
            }
        }

        async function getOrCreatePlayer(nameInput) {
            const trimmedName = nameInput.trim();
            if (!trimmedName) return null;
            
            // Check if it's an existing player ID (from datalist selection)
            const existingById = state.players.find(p => p.id === trimmedName);
            if (existingById) {
                return trimmedName;
            }
            
            // Check if a player with this exact name already exists
            const existingByName = state.players.find(p => p.name.toLowerCase() === trimmedName.toLowerCase());
            if (existingByName) {
                return existingByName.id;
            }
            
            // Create new player in database
            try {
                const docRef = await safeFirebaseCall('createPlayer', async () => {
                    return await addDoc(collection(state.db, PLAYERS_COLLECTION), {
                        name: trimmedName,
                        nickname: '',
                        team: state.userTeam,
                        stats: {},
                        isTemporary: true // Flag for admin review
                    });
                });
                
                showToast(`${trimmedName} added to roster.`);
                return docRef.id;
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error creating player:", error);
                    showToast("Could not create player.", 'error');
                }
                return null;
            }
        }
     
        async function archivePlayer(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            
            try {
                await safeFirebaseCall('archivePlayer', async () => {
                    const playerRef = doc(state.db, PLAYERS_COLLECTION, playerId);
                    return await updateDoc(playerRef, {
                        archived: true,
                        archivedAt: serverTimestamp()
                    });
                });
                showToast(`${player.name} has been archived.`);
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error archiving player:", error);
                    showToast("Could not archive player.", 'error');
                }
            }
        }

        async function unarchivePlayer(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            
            try {
                await safeFirebaseCall('unarchivePlayer', async () => {
                    const playerRef = doc(state.db, PLAYERS_COLLECTION, playerId);
                    return await updateDoc(playerRef, {
                        archived: false,
                        unarchivedAt: serverTimestamp()
                    });
                });
                showToast(`${player.name} has been restored to the roster.`);
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error unarchiving player:", error);
                    showToast("Could not unarchive player.", 'error');
                }
            }
        }

        function deleteFixture(fixtureId) {
            const fixture = state.previousFixtures.find(f => f.id === fixtureId);
            if (!fixture) return;
            openConfirmModal(
                'Delete Match?',
                `Are you sure you want to delete the match against ${fixture.oppositionName}? This action cannot be undone.`,
                'deleteFixture',
                fixtureId
            );
        }
        async function addScheduledFixture() {
            if (state.userRole === 'viewer' || state.userRole === 'scorer') {
                showToast("You don't have permission to add fixtures.", 'error');
                return;
            }
            if (!state.isLoggedIn) {
                showToast("You must be logged in to add a fixture.", 'error');
                return;
            }
            if (!state.activeSeasonId) {
                showToast("Please set an active season before adding a fixture.", 'warning');
                return;
            }

            // Show a modal for adding fixture details
            showAddFixtureModal();
        }

        async function startMatchFromScheduled(fixtureId) {
            if (state.userRole === 'viewer' || state.userRole === 'scorer') {
                showToast("You don't have permission to start matches.", 'error');
                return;
            }

            const scheduledFixture = state.upcomingFixtures.find(f => f.id === fixtureId);
            if (!scheduledFixture) {
                showToast("Fixture not found.", 'error');
                return;
            }

            try {
                // Update the fixture status to live and set up games with empty player selections
                const games = GAME_TITLES.map((title, i) => {
                    const isDoubles = title.includes("Doubles");
                    return {
                        title: title,
                        type: isDoubles ? 'doubles' : 'singles',
                        playerIds: [],
                        legsWon: 0,
                        legsLost: 0,
                        highCheckout: 0,
                        fines: 0,
                        finesList: [],
                        playerScores: []
                    };
                });

                await safeFirebaseCall('startMatch', async () => {
                    const fixtureRef = doc(state.db, FIXTURES_COLLECTION, fixtureId);
                    return await updateDoc(fixtureRef, {
                        status: 'live',
                        games: games,
                        activeGameIndex: 0,
                        createdAt: serverTimestamp() // Update to when match actually started
                    });
                });

                // Pre-fill the setup form with the fixture details
                ui.oppositionNameInput.value = scheduledFixture.oppositionName;
                if (scheduledFixture.scheduledDate) {
                    const matchDate = scheduledFixture.scheduledDate.toDate();
                    ui.matchDateInput.value = matchDate.toISOString().split('T')[0];
                }

                showToast("Match started! Please set up your team.", 'success');
                switchTab('setup');
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error starting match:", error);
                    showToast("Could not start the match.", 'error');
                }
            }
        }

        function showAddFixtureModal() {
            const modal = document.createElement('div');
            modal.id = 'add-fixture-modal';
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4';
            const isAdmin = state.userRole === 'admin';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold dark:text-white">Add Fixture</h3>
                        <button id="add-fixture-close" class="text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-4">
                        ${isAdmin ? `
                        <div>
                            <label for="fixture-team-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Team</label>
                            <select id="fixture-team-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="A" ${state.activeMatchView === 'A' ? 'selected' : ''}>Team A</option>
                                <option value="B" ${state.activeMatchView === 'B' ? 'selected' : ''}>Team B</option>
                            </select>
                        </div>
                        ` : ''}
                        <div>
                            <label for="fixture-location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                            <select id="fixture-location" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="Away">Away</option>
                                <option value="Home">Home</option>
                            </select>
                        </div>
                        <div>
                            <label for="fixture-opposition" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Opposition</label>
                            <input type="text" id="fixture-opposition" placeholder="e.g., The King's Arms" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label for="fixture-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Match Date</label>
                            <input type="date" id="fixture-date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label for="fixture-venue" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Venue (optional)</label>
                            <input type="text" id="fixture-venue" placeholder="e.g., The King's Arms" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div id="fixture-address-container">
                            <label for="fixture-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Address (for maps)</label>
                            <input type="text" id="fixture-address" placeholder="e.g., 123 High Street, Burnaby Village, BC V5A 1A1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button id="add-fixture-cancel" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-xl">Cancel</button>
                            <button id="add-fixture-submit" class="bg-emerald-600 text-white py-2 px-4 rounded-xl hover:bg-emerald-700 transition-colors">Add Fixture</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');

            // Set default date to today
            document.getElementById('fixture-date').value = new Date().toISOString().split('T')[0];

            // Event listeners
            document.getElementById('add-fixture-close').addEventListener('click', closeAddFixtureModal);
            document.getElementById('add-fixture-cancel').addEventListener('click', closeAddFixtureModal);
            document.getElementById('add-fixture-submit').addEventListener('click', submitAddFixture);
            // Hide/show address field based on location selection
            document.getElementById('fixture-location').addEventListener('change', (e) => {
                const addressContainer = document.getElementById('fixture-address-container');
                const addressInput = document.getElementById('fixture-address');
                const venueInput = document.getElementById('fixture-venue');

                if (e.target.value === 'Home') {
                    addressContainer.style.display = 'none';
                    addressInput.value = ''; // Clear the address when hiding
                    venueInput.value = 'The Burnaby Arms'; // Auto-fill home venue
                } else {
                    addressContainer.style.display = 'block';
                    if (venueInput.value === 'The Burnaby Arms') {
                        venueInput.value = ''; // Clear venue if it was auto-filled
                    }
                }
            });
        }

        function closeAddFixtureModal() {
            const modal = document.getElementById('add-fixture-modal');
            if (modal) {
                modal.remove();
                document.body.classList.remove('modal-open');
            }
        }

        async function submitAddFixture() {
            const oppositionName = validateInput(document.getElementById('fixture-opposition').value);
            const fixtureDate = document.getElementById('fixture-date').value;
            const venue = document.getElementById('fixture-venue').value.trim();
            const location = document.getElementById('fixture-location').value;
            const address = document.getElementById('fixture-address').value.trim();

            if (!oppositionName) {
                showToast("Please enter an opposition name.", 'warning');
                return;
            }
            if (!fixtureDate) {
                showToast("Please select a match date.", 'warning');
                return;
            }

            // For admins, get the selected team; for members, use their team
            const fixtureTeam = state.userRole === 'admin' 
                ? document.getElementById('fixture-team-select')?.value || state.userTeam 
                : state.userTeam;

            if (!fixtureTeam) {
                showToast("Please select a team for this fixture.", 'warning');
                return;
            }

            try {
                const scheduledDate = Timestamp.fromDate(new Date(fixtureDate));       

                // Create empty games structure for scheduled fixture
                const games = GAME_TITLES.map((title) => {
                    const isDoubles = title.includes("Doubles");
                    return {
                        title: title,
                        type: isDoubles ? 'doubles' : 'singles',
                        playerIds: [],
                        legsWon: 0,
                        legsLost: 0,
                        highCheckout: 0,
                        fines: 0,
                        finesList: [],
                        playerScores: []
                    };
                });

                await safeFirebaseCall('addScheduledFixture', async () => {
                    return await addDoc(collection(state.db, FIXTURES_COLLECTION), {
                        seasonId: state.activeSeasonId,
                        team: fixtureTeam, // Assign to selected team (admin) or user's team (member)
                        oppositionName: oppositionName,
                        scheduledDate: scheduledDate,
                        venue: venue || null,
                        location: location,
                        address: address || null,
                        games: games,
                        status: 'scheduled',
                        createdAt: serverTimestamp()
                    });
                });

                showToast(`Fixture against ${oppositionName} added!`);
                closeAddFixtureModal();
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else if (error.message.includes('Invalid characters') || error.message.includes('Input too long')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error adding fixture:", error);
                    showToast("Could not add fixture.", 'error');
                }
            }
        }

        function deleteUpcomingFixture(fixtureId) {
            const fixture = state.upcomingFixtures.find(f => f.id === fixtureId);
            if (!fixture) return;
            openConfirmModal(
                'Delete Fixture?',
                `Are you sure you want to delete the fixture against ${fixture.oppositionName}? This action cannot be undone.`,
                'deleteUpcomingFixture',
                fixtureId
            );
        }

        function deletePreviousFixture(fixtureId) {
            const fixture = state.previousFixtures.find(f => f.id === fixtureId);
            if (!fixture) return;
            openConfirmModal(
                'Delete Match?',
                `Are you sure you want to delete the match against ${fixture.oppositionName}? This action cannot be undone.`,
                'deletePreviousFixture',
                fixtureId
            );
        }

        async function createFixture() {
            triggerHaptic('medium');
            if (state.userRole === 'viewer' || state.userRole === 'scorer') {
                showToast("You don't have permission to create matches.", 'error');
                return;
            }
            if (!state.isLoggedIn) {
                showToast("You must be logged in to create a match.", 'error');
                return;
            }
            if (!state.activeSeasonId) {
                showToast("Please set an active season before creating a match.", 'warning');
                return;
            }
            const oppositionName = ui.oppositionNameInput.value.trim();
            if(!oppositionName) {
                showToast("Please enter an opposition name.", 'warning');
                return;
            }

            const dateValue = ui.matchDateInput.value;
            let createdAt;

            if (dateValue) {
                const parts = dateValue.split('-');
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                const selectedDate = new Date(year, month, day);
                createdAt = Timestamp.fromDate(selectedDate);
            } else {
                createdAt = serverTimestamp();
            }

            const games = [];
            for (let i = 0; i < GAME_TITLES.length; i++) {
                const title = GAME_TITLES[i];
                const isDoubles = title.includes("Doubles");
            
                const p1Input = document.getElementById(`game-${i}-p1-input`);
                const p1Value = p1Input.value.trim();
                
                // Get or create player ID for player 1
                const p1Id = await getOrCreatePlayer(p1Value);
                if (!p1Id && p1Value) {
                    showToast(`Could not add player for ${title}.`, 'error');
                    return;
                }
            
                const playerIds = p1Id ? [p1Id] : [];
                
                if (isDoubles) {
                    const p2Input = document.getElementById(`game-${i}-p2-input`);
                    const p2Value = p2Input.value.trim();
                    
                    // Get or create player ID for player 2
                    const p2Id = await getOrCreatePlayer(p2Value);
                    
                    if (p1Id && p2Id && p1Id === p2Id) {
                        showToast(`A player cannot play with themselves in ${title}.`, 'error');
                        return;
                    }
                    
                    if (p2Id) playerIds.push(p2Id);
                }
            
                const playerScores = playerIds.map(() => ({
                    scores100: 0,
                    scores140: 0,
                    scores180: 0,
                    sillyThings: 0,
                }));
            
                games.push({
                    title: title,
                    type: isDoubles ? 'doubles' : 'singles',
                    playerIds: playerIds,
                    legsWon: 0,
                    legsLost: 0,
                    highCheckout: 0,
                    fines: 0,
                    finesList: [],
                    playerScores: playerScores
                });
            }

            try {
                await safeFirebaseCall('createFixture', async () => {
                    return await addDoc(collection(state.db, FIXTURES_COLLECTION), {
                        seasonId: state.activeSeasonId,
                        team: state.userTeam, // Assign fixture to user's team
                        oppositionName: oppositionName,
                        games: games,
                        activeGameIndex: 0,
                        status: 'live',
                        createdAt: createdAt,
                        scheduledDate: createdAt
                    });
                });
                showToast("Fixture created! Let's play darts!");
                ui.oppositionNameInput.value = '';
                ui.matchDateInput.value = '';
                switchTab('live');
            } catch (error) {
                console.error("Error creating fixture: ", error);
                showToast("Could not create the fixture.", 'error');
            }
        }

        async function updateGameData() {
            if (!state.fixture.id) return;
            const fixtureRef = doc(state.db, FIXTURES_COLLECTION, state.fixture.id);
            try {
                await safeFirebaseCall('updateGame', async () => {
                    return await updateDoc(fixtureRef, {
                        games: state.fixture.games,
                        activeGameIndex: state.fixture.activeGameIndex || 0
                    });
                });
            } catch (error) {
                if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error updating game data:", error);
                    showToast("Could not save latest score, check connection.", 'error');
                }
            }
        }

        function updateStat(stat, value, playerIndex = 0) {
            const game = state.fixture.games[state.currentGameIndex];
            if (!game) return;

            if (stat === 'legsWon' || stat === 'legsLost') {
                if (value > 0) {
                    if ((game.legsWon || 0) + (game.legsLost || 0) >= 3) {
                        showToast("Cannot play more than 3 legs in a game.", 'error');
                        return;
                    }
                }
            }

            if (!game.playerScores) game.playerScores = [{}, {}];

            if(stat.startsWith('scores') || stat === 'sillyThings') {
                const playerScores = game.playerScores[playerIndex] || {};
                playerScores[stat] = Math.max(0, (playerScores[stat] || 0) + value);
                game.playerScores[playerIndex] = playerScores;
            } else {
                 game[stat] = Math.max(0, (game[stat] || 0) + value);
            }
            render();
            updateGameData();
        }

        async function addFine(amount, reason) {
            const game = state.fixture.games[state.currentGameIndex];
            if (!game) return;
        
            // Create unique fine with timestamp + user ID for better uniqueness
            const fineId = `${Date.now()}-${state.userId || 'anon'}-${Math.random().toString(36).substr(2, 9)}`;
            const newFine = {
                id: fineId,
                amount: amount,
                reason: reason,
                timestamp: new Date().toISOString(),
                addedBy: state.userId || 'anonymous'
            };
        
            try {
                const fixtureRef = doc(state.db, FIXTURES_COLLECTION, state.fixture.id);
                
                await safeFirebaseCall('addFine', async () => {
                    return await runTransaction(state.db, async (transaction) => {
                        const fixtureDoc = await transaction.get(fixtureRef);
                        if (!fixtureDoc.exists()) {
                            throw new Error("Fixture document does not exist!");
                        }
                        
                        const serverData = fixtureDoc.data();
                        const currentGame = serverData.games[state.currentGameIndex];
                        
                        // Check if this exact fine already exists (prevent duplicates)
                        const existingFines = currentGame.finesList || [];
                        const duplicateFine = existingFines.find(f => 
                            f.reason === reason && 
                            f.amount === amount && 
                            Math.abs(new Date(f.timestamp).getTime() - new Date(newFine.timestamp).getTime()) < 5000 // Within 5 seconds
                        );
                        
                        if (duplicateFine) {
                            throw new Error('DUPLICATE_FINE');
                        }
                        
                        // Add fine to server data
                        const updatedFinesList = [...existingFines, newFine];
                        const updatedFinesTotal = (currentGame.fines || 0) + amount;
                        
                        const updatedGames = [...serverData.games];
                        updatedGames[state.currentGameIndex] = {
                            ...currentGame,
                            finesList: updatedFinesList,
                            fines: updatedFinesTotal
                        };
                        
                        return transaction.update(fixtureRef, {
                            games: updatedGames
                        });
                    });
                });
                
                showToast(`Fine added: ${reason} (+£${(amount/100).toFixed(2)})`);
                
            } catch (error) {
                if (error.message === 'DUPLICATE_FINE') {
                    showToast(`Fine already added by another scorer!`, 'warning');
                } else if (error.message.includes('Rate limit')) {
                    showToast(error.message, 'error');
                } else {
                    console.error("Error adding fine:", error);
                    showToast("Could not add fine, please try again.", 'error');
                }
            }
        }

        // --- FIX STARTS HERE ---
        // This function saves the final stats to the database.
        // It's been updated to be more robust, ensuring the singles/doubles
        // categories exist in Firestore before trying to save stats to them.
        async function finishMatch(dotdPlayerId) {
            const fixtureRef = doc(state.db, FIXTURES_COLLECTION, state.fixture.id);
            const seasonId = state.fixture.seasonId;

            try {
                state.fixture.games.forEach(game => {
                    if (!game.playerNames) {
                        game.playerNames = game.playerIds.map(id =>
                            state.players.find(p => p.id === id)?.name || 'Unknown'
                        );
                    }
                });

                await runTransaction(state.db, async (transaction) => {
                    const allPlayerIds = [...new Set(state.fixture.games.flatMap(game => game.playerIds))];
                    if (dotdPlayerId && !allPlayerIds.includes(dotdPlayerId)) {
                        allPlayerIds.push(dotdPlayerId);
                    }

                    // 1. READS: Get all player documents first.
                    const playerRefs = allPlayerIds.map(id => doc(state.db, PLAYERS_COLLECTION, id));
                    const playerDocs = await Promise.all(playerRefs.map(ref => transaction.get(ref)));

                    // Create enhanced audit log for match completion
                    const matchAuditData = {
                        action: 'match_completed',
                        fixtureId: state.fixture.id,
                        oppositionName: state.fixture.oppositionName,
                        seasonId: seasonId,
                        seasonName: state.seasons.find(s => s.id === seasonId)?.name || 'Unknown Season',
                        completedBy: state.userName || state.userEmail || 'Unknown',
                        completedByUserId: state.userId,
                        players: allPlayerIds.map(playerId => {
                            const playerDoc = playerDocs.find(doc => doc.id === playerId);
                            const playerData = playerDoc?.exists() ? playerDoc.data() : {};
                            return {
                                playerId: playerId,
                                playerName: playerData.name || 'Unknown'
                            };
                        }),
                        dotdWinner: dotdPlayerId ? {
                            playerId: dotdPlayerId,
                            playerName: state.players.find(p => p.id === dotdPlayerId)?.name || 'Unknown'
                        } : null,
                        gameResults: state.fixture.games.map(game => ({
                            title: game.title,
                            type: game.type,
                            playerNames: game.playerIds.map(id =>
                                state.players.find(p => p.id === id)?.name || 'Unknown'
                            ),
                            legsWon: game.legsWon || 0,
                            legsLost: game.legsLost || 0
                        })),
                        timestamp: serverTimestamp(),
                        userAgent: navigator.userAgent
                    };

                    // Add the audit log
                    const auditRef = doc(collection(state.db, 'audit_logs'));
                    transaction.set(auditRef, matchAuditData);

                    const playerUpdates = {};

                    // 2. CALCULATIONS: Prepare updates in memory.
                    for (let i = 0; i < allPlayerIds.length; i++) {
                        const playerId = allPlayerIds[i];
                        const playerDoc = playerDocs[i];

                        if (!playerDoc.exists()) continue;

                        const playerData = playerDoc.data();
                        const newStats = JSON.parse(JSON.stringify(playerData.stats || {}));

                        // Ensure data structure exists
                        if (!newStats[seasonId]) newStats[seasonId] = {};
                        if (!newStats[seasonId].singles) newStats[seasonId].singles = {};
                        if (!newStats[seasonId].doubles) newStats[seasonId].doubles = {};

                        state.fixture.games.forEach(game => {
                            if (!game.playerIds.includes(playerId)) return;

                            const playerIndex = game.playerIds.indexOf(playerId);
                            const pScores = game.playerScores?.[playerIndex] || {};
                            const gameType = game.type;
                            const gameWon = game.legsWon > game.legsLost;

                            const seasonStats = newStats[seasonId][gameType];

                            seasonStats.gamesWon = (seasonStats.gamesWon || 0) + (gameWon ? 1 : 0);
                            seasonStats.gamesLost = (seasonStats.gamesLost || 0) + (!gameWon ? 1 : 0);
                            seasonStats.legsWon = (seasonStats.legsWon || 0) + (game.legsWon || 0);
                            seasonStats.legsLost = (seasonStats.legsLost || 0) + (game.legsLost || 0);
                            seasonStats.scores100 = (seasonStats.scores100 || 0) + (pScores.scores100 || 0);
                            seasonStats.scores140 = (seasonStats.scores140 || 0) + (pScores.scores140 || 0);
                            seasonStats.scores180 = (seasonStats.scores180 || 0) + (pScores.scores180 || 0);

                            if (gameType === 'singles') {
                                const singlesSeasonStats = newStats[seasonId].singles;
                                singlesSeasonStats.outstandingFines = (singlesSeasonStats.outstandingFines || 0) + (game.fines || 0);
                                singlesSeasonStats.totalFines = (singlesSeasonStats.totalFines || 0) + (game.fines || 0);
                                if (game.highCheckout > (singlesSeasonStats.highCheckout || 0)) {
                                    singlesSeasonStats.highCheckout = game.highCheckout;
                                }
                            } else if (gameType === 'doubles') {
                                // For doubles, check individual player high checkouts
                                const playerHighCheckout = pScores.highCheckout || 0;
                                if (playerHighCheckout > (seasonStats.highCheckout || 0)) {
                                    seasonStats.highCheckout = playerHighCheckout;
                                }
                            }
                        });

                        if (dotdPlayerId === playerId) {
                            const singlesSeasonStats = newStats[seasonId].singles;
                            singlesSeasonStats.outstandingFines = (singlesSeasonStats.outstandingFines || 0) + 250;
                            singlesSeasonStats.totalFines = (singlesSeasonStats.totalFines || 0) + 250;
                        }

                        playerUpdates[playerId] = { stats: newStats };
                    }

                    // 3. WRITES: Perform all writes at the end.
                    transaction.update(fixtureRef, { status: 'finished' });
                    for (const playerId in playerUpdates) {
                        const playerRef = doc(state.db, PLAYERS_COLLECTION, playerId);
                        transaction.update(playerRef, playerUpdates[playerId]);
                    }
                });

                showToast("Match finished and all stats saved! Well played.", 'success');
                ui.dotdModal.overlay.classList.add('hidden');
                ui.dotdModal.overlay.classList.remove('flex');
                document.body.classList.remove('modal-open');
                switchTab('match');

            } catch (e) {
                console.error("Transaction failed: ", e);
                showToast("Failed to save match stats. Please try again.", 'error');
            }
        }
        // --- FIX ENDS HERE ---

        async function markFinesAsPaid(playerId) {
            const playerRef = doc(state.db, "players", playerId);
            try {
                const player = state.players.find(p => p.id === playerId);
                if (!player || !player.stats) {
                    showToast("Player has no stats to clear.", 'error');
                    return;
                }

                // Calculate total outstanding fines before clearing
                const allTimeStats = getPlayerStats(player, 'all-time', 'singles');
                const totalOutstandingFines = allTimeStats.outstandingFines;

                // Add enhanced audit logging for fines clearing
                await safeFirebaseCall('auditLog', async () => {
                    return await addDoc(collection(state.db, 'audit_logs'), {
                        action: 'fines_cleared',
                        targetPlayerId: playerId,
                        targetPlayerName: player.name,
                        finesCleared: totalOutstandingFines,
                        clearedBy: state.userName || state.userEmail || 'Unknown',
                        clearedByUserId: state.userId,
                        clearedByEmail: state.userEmail,
                        timestamp: serverTimestamp(),
                        userAgent: navigator.userAgent
                    });
                });

                const updates = {};
                for (const seasonId in player.stats) {
                    updates[`stats.${seasonId}.singles.outstandingFines`] = 0;
                }
                await updateDoc(playerRef, updates);
            } catch (error) {
                console.error("Error clearing fines: ", error);
                showToast("Could not clear fines.", 'error');
            }
        }

        function openLowScoreModal() {
            ui.lowScoreModal.overlay.classList.remove('hidden');
            ui.lowScoreModal.overlay.classList.add('flex');
            ui.lowScoreModal.input.focus();
            document.body.classList.add('modal-open');
        }
        function closeLowScoreModal() {
            ui.lowScoreModal.overlay.classList.add('hidden');
            ui.lowScoreModal.overlay.classList.remove('flex');
            ui.lowScoreModal.input.value = '';
            document.body.classList.remove('modal-open');
        }
        function submitLowScoreFine() {
            const score = parseInt(ui.lowScoreModal.input.value);
            if (score >= 1 && score <= 9) {
                addFine((10 - score) * 10, `Score of ${score}`);
                closeLowScoreModal();
            } else {
                showToast("Please enter a score between 1 and 9.", 'warning');
            }
        }

        function removeFine(fineId) {
            const game = state.fixture.games[state.currentGameIndex];
            if (!game || !game.finesList) return;

            const fineIndex = game.finesList.findIndex(f => f.id === fineId);
            if (fineIndex === -1) return;

            const removedFine = game.finesList[fineIndex];
            game.finesList.splice(fineIndex, 1);

            // Update total fines
            game.fines = Math.max(0, (game.fines || 0) - removedFine.amount);

            showToast(`Fine removed: ${removedFine.reason} (-£${(removedFine.amount/100).toFixed(2)})`);
            render();
            updateGameData();
        }

        function openDotdModal() {
            showToast('Match Complete!');

            const allPlayerIdsInFixture = [...new Set(state.fixture.games.flatMap(game => game.playerIds))];

            ui.dotdModal.list.innerHTML = '';
            allPlayerIdsInFixture.forEach(playerId => {
                const player = state.players.find(p => p.id === playerId);
                if (!player) return;

                let sillyThingsCount = 0;
                state.fixture.games.forEach(game => {
                    if (game.playerIds.includes(playerId)) {
                        const playerIndex = game.playerIds.indexOf(playerId);
                        sillyThingsCount += game.playerScores?.[playerIndex]?.sillyThings || 0;
                    }
                });

                const playerEl = document.createElement('div');
                playerEl.className = 'flex items-center justify-between';
                playerEl.innerHTML = `
                    <div>
                        <input id="dotd-${player.id}" name="dotd-vote" type="radio" value="${player.id}" class="h-4 w-4 text-emerald-600 border-gray-300 focus:ring-emerald-500">
                        <label for="dotd-${player.id}" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">${player.name}</label>
                    </div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">? x ${sillyThingsCount}</span>
                `;
                ui.dotdModal.list.appendChild(playerEl);
            });

            ui.dotdModal.overlay.classList.remove('hidden');
            ui.dotdModal.overlay.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function renderH2HTab() {
            const playerOptions = state.players.filter(p => !p.archived).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            ui.h2h.player1Select.innerHTML = `<option value="">Select Player 1</option>${playerOptions}`;
            ui.h2h.player2Select.innerHTML = `<option value="">Select Player 2</option>${playerOptions}`;

            if(state.h2h.player1) ui.h2h.player1Select.value = state.h2h.player1;
            if(state.h2h.player2) ui.h2h.player2Select.value = state.h2h.player2;
        }

        function calculateAndRenderH2H() {
            const p1Id = state.h2h.player1;
            const p2Id = state.h2h.player2;
            const container = ui.h2h.resultsContainer;

            if (!p1Id || !p2Id || p1Id === p2Id) {
                container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Select two different players to compare their stats.</p>';
                return;
            }

            const player1 = state.players.find(p => p.id === p1Id);
            const player2 = state.players.find(p => p.id === p2Id);

            const p1Stats = getPlayerStats(player1, 'all-time', 'combined');
            const p2Stats = getPlayerStats(player2, 'all-time', 'combined');

            const renderStatRow = (label, val1, val2) => {
                const isP1Winner = val1 > val2;
                const isP2Winner = val2 > val1;
                return `
                    <div class="flex justify-between items-center py-2">
                        <span class="font-semibold ${isP1Winner ? 'text-emerald-500' : 'dark:text-white'}">${val1}</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">${label}</span>
                        <span class="font-semibold ${isP2Winner ? 'text-emerald-500' : 'dark:text-white'}">${val2}</span>
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                     <div class="text-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                         <h3 class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${player1.name}</h3>
                     </div>
                     <div class="text-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                         <h3 class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${player2.name}</h3>
                     </div>
                </div>
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                    ${renderStatRow('Games Won', p1Stats.gamesWon, p2Stats.gamesWon)}
                    ${renderStatRow('Legs Won', p1Stats.legsWon, p2Stats.legsWon)}
                    ${renderStatRow('Leg Win %', parseFloat(((p1Stats.legsWon + p1Stats.legsLost > 0) ? (p1Stats.legsWon / (p1Stats.legsWon + p1Stats.legsLost) * 100) : 0).toFixed(1)), parseFloat(((p2Stats.legsWon + p2Stats.legsLost > 0) ? (p2Stats.legsWon / (p2Stats.legsWon + p2Stats.legsLost) * 100) : 0).toFixed(1)))}
                    ${renderStatRow('100+', p1Stats.scores100, p2Stats.scores100)}
                    ${renderStatRow('140+', p1Stats.scores140, p2Stats.scores140)}
                    ${renderStatRow('180s', p1Stats.scores180, p2Stats.scores180)}
                    ${renderStatRow('High Checkout', p1Stats.highCheckout, p2Stats.highCheckout)}
                    ${renderStatRow('Total Fines (£)', (p1Stats.totalFines/100).toFixed(2), (p2Stats.totalFines/100).toFixed(2))}
                </div>
                <p class="text-xs text-center text-gray-400 mt-4">* Singles stats shown for wins/legs/HC/fines. All scores included.</p>
            `;
        }

         function setupProfileTabs(container) {
            const singlesTab = container.querySelector('#profile-tab-singles');
            const doublesTab = container.querySelector('#profile-tab-doubles');
            const singlesContent = container.querySelector('#profile-content-singles');
            const doublesContent = container.querySelector('#profile-content-doubles');

            if (!singlesTab || !doublesTab || !singlesContent || !doublesContent) return;

            singlesTab.addEventListener('click', () => {
                singlesTab.classList.add('text-emerald-600', 'border-emerald-500');
                singlesTab.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                doublesTab.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                doublesTab.classList.remove('text-emerald-600', 'border-emerald-500');
                singlesContent.classList.remove('hidden');
                doublesContent.classList.add('hidden');
            });

            doublesTab.addEventListener('click', () => {
                doublesTab.classList.add('text-emerald-600', 'border-emerald-500');
                doublesTab.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                singlesTab.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                singlesTab.classList.remove('text-emerald-600', 'border-emerald-500');
                doublesContent.classList.remove('hidden');
                singlesContent.classList.add('hidden');
            });
        }

        function renderMyProfile() {
            let selectedPlayerId = null;
            let hideSelector = false;

            // If user is logged in and has a linked player ID, use that automatically
            if (state.isLoggedIn && state.userPlayerId) {
                selectedPlayerId = state.userPlayerId;
                state.myProfile.selectedPlayerId = state.userPlayerId;
                hideSelector = true;
            } else {
                // Use manually selected player
                selectedPlayerId = state.myProfile.selectedPlayerId;
            }

            // Show/hide player selector based on whether user has linked profile
            if (hideSelector) {
                ui.myProfile.playerSelect.parentElement.classList.add('hidden');
            } else {
                ui.myProfile.playerSelect.parentElement.classList.remove('hidden');
                const playerOptions = state.players.filter(p => !p.archived).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                ui.myProfile.playerSelect.innerHTML = `<option value="">Select a player...</option>${playerOptions}`;
                if (selectedPlayerId) {
                    ui.myProfile.playerSelect.value = selectedPlayerId;
                }
            }

            // Handle the selected player (whether auto or manual)
            if (selectedPlayerId) {
                const player = state.players.find(p => p.id === selectedPlayerId);
                if (player) {
                    ui.myProfile.nameInput.value = player.name;
                    ui.myProfile.nicknameInput.value = player.nickname || '';

                    // Only admins can edit profiles
                    if (state.userRole !== 'admin') {
                        ui.myProfile.nameInput.disabled = true;
                        ui.myProfile.nicknameInput.disabled = true;
                        ui.myProfile.saveBtn.style.display = 'none';
                    } else {
                        ui.myProfile.nameInput.disabled = false;
                        ui.myProfile.nicknameInput.disabled = false;
                        ui.myProfile.saveBtn.style.display = 'block';
                    }

                    ui.myProfile.editArea.classList.remove('hidden');
                    ui.myProfile.statsArea.classList.remove('hidden');

                    const cardHTML = generatePlayerCardHTML(player.id, 'all-time');
                    ui.myProfile.statsArea.innerHTML = cardHTML;
                    ui.myProfile.statsArea.querySelector('#player-card-season-select')?.remove();
                    setupProfileTabs(ui.myProfile.statsArea);
                }
            } else {
                ui.myProfile.editArea.classList.add('hidden');
                ui.myProfile.statsArea.classList.add('hidden');
            }
        }
        async function handleUpdateProfile() {
            const playerId = state.myProfile.selectedPlayerId || state.userPlayerId;

            // Check permissions - only admin can update profiles
            if (state.userRole !== 'admin') {
                showToast("Only admins can update player profiles.", 'error');
                return;
            }

            if (!playerId) {
                showToast("Please select a profile to update.", 'error');
                return;
            }

            const newName = ui.myProfile.nameInput.value.trim();
            const newNickname = ui.myProfile.nicknameInput.value.trim();

            if (!newName) {
                showToast("Player name cannot be empty.", 'warning');
                return;
            }

            try {
                const playerRef = doc(state.db, PLAYERS_COLLECTION, playerId);
                await updateDoc(playerRef, {
                    name: newName,
                    nickname: newNickname
                });
                showToast("Profile updated successfully!");
            } catch (error) {
                console.error("Error updating profile:", error);
                showToast("Could not update profile.", 'error');
            }
        }


        function handleThemeToggle() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            ui.themeIconsMobile.sun.classList.toggle('hidden', isDark);
            ui.themeIconsMobile.moon.classList.toggle('hidden', !isDark);
        }

        async function init() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                ui.themeIconsMobile.sun.classList.add('hidden');
                ui.themeIconsMobile.moon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                ui.themeIconsMobile.sun.classList.remove('hidden');
                ui.themeIconsMobile.moon.classList.add('hidden');
            }

            // Validate storage before using it
            validateStoredData();

            // Use dev Firebase when in Codespaces, production otherwise
            const isDevelopment = location.hostname.includes('github.dev') || location.hostname.includes('codespaces') || location.hostname.includes('app.github.dev') || location.hostname.includes('localhost');

            const firebaseConfig = isDevelopment
                ? {
                    // DEV PROJECT CONFIG - Get these from your dev Firebase project
                    apiKey: "AIzaSyC6Ctix8MZtCj6AkWCLkwtZPayOidXLITA",
                    authDomain: "burnabydartsdev.firebaseapp.com",
                    projectId: "burnabydartsdev",
                    storageBucket: "burnabydartsdev.firebasestorage.app",
                    messagingSenderId: "372591363063",
                    appId: "1:372591363063:web:84fee08add7b4d1abce4f2"
                  }
                : {
                    // PRODUCTION CONFIG (your existing)
                    apiKey: "AIzaSyCU66DqSCzkwaEhTLEOftEJtKbt9y4xVeI",
                    authDomain: "darts-app-9e752.firebaseapp.com",
                    databaseURL: "https://darts-app-9e752-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "darts-app-9e752",
                    storageBucket: "darts-app-9e752.appspot.com",
                    messagingSenderId: "520662271304",
                    appId: "1:520662271304:web:abb1ca68445511c8bb1f7d"
                  };

            // Show dev indicator if in development
            if (isDevelopment) {
                const devIndicator = document.getElementById('dev-indicator');
                const dbInfo = document.getElementById('dev-db-info');
                devIndicator.classList.remove('hidden');
                dbInfo.textContent = `DB: ${firebaseConfig.projectId}`;
            }

            const app = initializeApp(firebaseConfig);
            state.db = getFirestore(app);
            state.auth = getAuth(app);

            ui.connectionStatus.classList.remove('hidden');

            try {
                // const userCredential = await signInAnonymously(state.auth);
                //state.userId = userCredential.user.uid;
                console.log("Authentication successful. UID:", state.userId);
            } catch (error) {
                console.error("Firebase Authentication Failed:", error);
                ui.connectionStatus.textContent = "Authentication failed. App may not work.";
                ui.connectionStatus.classList.replace('bg-yellow-100', 'bg-red-100');
                ui.connectionStatus.classList.replace('text-yellow-800', 'text-red-800');
                return;
            }

            const handleError = (error, type) => {
                 console.error(`Error fetching ${type}: `, error);
                 ui.connectionStatus.innerHTML = `<strong>Database Error:</strong> Could not load ${type}. Please check Firestore security rules.`;
                 ui.connectionStatus.classList.replace('bg-yellow-100', 'bg-red-100');
                 ui.connectionStatus.classList.replace('text-yellow-800', 'text-red-800');
                 ui.connectionStatus.classList.remove('hidden');
            };

            // Add multiple event handlers for better mobile support
            function handleAppReturn() {
                if (state.isLoggedIn || state.userRole === 'viewer') {
                    console.log('App became active, refreshing connections...');

                    // Small delay to ensure connection is stable
                    setTimeout(() => {
                        setupFirestoreListeners();
                        render();
                    }, 1000);
                }
            }

            // Desktop/mobile visibility change
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    handleAppReturn();
                }
            });

            // Mobile-specific events
            window.addEventListener('focus', handleAppReturn);
            window.addEventListener('pageshow', (event) => {
                // Handle page restore from cache (mobile Safari)
                if (event.persisted) {
                    handleAppReturn();
                }
            });

            // Mobile app lifecycle events (if available)
            if ('serviceWorker' in navigator) {
                // Handle when app comes back from background
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'APP_RESUMED') {
                        handleAppReturn();
                    }
                });
            }

            // Additional mobile detection - some mobile browsers fire resume events
            document.addEventListener('resume', handleAppReturn);

            // Handle online/offline status changes (mobile networks)
            window.addEventListener('online', () => {
                console.log('Network connection restored');
                setTimeout(handleAppReturn, 500);
            });

            // Wait for auth state before setting up Firestore listeners
            // Wait for auth state and properly handle session restoration
            onAuthStateChanged(state.auth, async (user) => {


                if (user) {
                    state.userId = user.uid;

                    try {
                        // Check if this user has a role in Firestore
                        const userDoc = await getDoc(doc(state.db, 'users', user.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            state.userRole = userData.role;
                            state.userEmail = userData.email;
                            state.userName = userData.name;
                            state.userPlayerId = userData.playerId;
                            state.userTeam = userData.team || null;
                            state.isLoggedIn = true;

                            console.log('Auth state changed - role:', userData.role); // Debug log

                            // Update localStorage with fresh data
                            localStorage.setItem('userRole', userData.role);
                            localStorage.setItem('isLoggedIn', 'true');
                            localStorage.setItem('userEmail', userData.email);
                            localStorage.setItem('userId', user.uid);

                            // Start logout timer
                            startLogoutTimer();
                        }
                    } catch (error) {
                        console.log('Error fetching user document:', error);
                        // If we can't get user data, clear everything
                        state.isLoggedIn = false;
                        state.userRole = null;
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('loginTimestamp');
                        localStorage.removeItem('userEmail');
                        localStorage.removeItem('userId');
                    }
                } else {
                    // Not authenticated - check if we should show viewer mode
                    const savedRole = localStorage.getItem('userRole');
                    if (savedRole === 'viewer') {
                        state.userRole = 'viewer';
                        state.isLoggedIn = false;
                    } else {
                        // Clear everything if not authenticated and not viewer
                        state.isLoggedIn = false;
                        state.userRole = null;
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('loginTimestamp');
                        localStorage.removeItem('userEmail');
                        localStorage.removeItem('userId');
                    }
                }

                // NOW set up UI and Firestore listeners after auth is fully resolved
                if (state.isLoggedIn || state.userRole === 'viewer') {
                    ui.roleSelectionOverlay.classList.add('hidden');
                    ui.mainApp.classList.remove('hidden');
                } else {
                    ui.roleSelectionOverlay.classList.remove('hidden');
                    ui.mainApp.classList.add('hidden');
                }

                setupFirestoreListeners();
                render();

                // Hide loading overlay once auth state is resolved
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('opacity-100');
                    loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                }
            });
            function setupFirestoreListeners() {
                // Store unsubscribe functions to clean up previous listeners if they exist
                if (state.unsubscribeFunctions) {
                    state.unsubscribeFunctions.forEach(unsub => unsub());
                }
                state.unsubscribeFunctions = [];

                const seasonsUnsub = onSnapshot(query(collection(state.db, SEASONS_COLLECTION)), (snapshot) => {
                    state.seasons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.seasons.sort((a,b) => a.name.localeCompare(b.name));
                    const activeSeason = state.seasons.find(s => s.status === 'active');
                    state.activeSeasonId = activeSeason ? activeSeason.id : null;
                    render();
                }, (error) => handleError(error, 'seasons'));

                const playersUnsub = onSnapshot(query(collection(state.db, PLAYERS_COLLECTION)), (snapshot) => {
                    ui.connectionStatus.classList.add('hidden');
                    state.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.players.sort((a, b) => a.name.localeCompare(b.name));
                    render();
                }, (error) => handleError(error, 'players'));

                const fixturesUnsub = onSnapshot(query(collection(state.db, FIXTURES_COLLECTION)), (snapshot) => {
                    ui.connectionStatus.classList.add('hidden');
                    const allFixtures = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Find active fixture for the current user's team
                    const userTeam = state.userTeam || state.activeMatchView;
                    const activeFixture = allFixtures.find(f => f.status === 'live' && f.team === userTeam);
                    
                    if (activeFixture) {
                        state.fixture = activeFixture;
                        state.currentGameIndex = activeFixture.activeGameIndex || 0;
                        state.fixture.activeGameIndex = state.currentGameIndex;
                        state.lastTurnSeq = state.fixture.games[state.currentGameIndex]?.turnSeq || 0;
                    } else {
                        state.fixture = { id: null, games: [], activeGameIndex: 0, team: userTeam };
                        state.currentGameIndex = 0;
                        state.lastTurnSeq = 0;
                    }

                    state.previousFixtures = allFixtures
                        .filter(f => f.status === 'finished')
                        .sort((a, b) => {
                            const dateA = a.scheduledDate?.toMillis ? a.scheduledDate.toMillis() : (a.createdAt?.toMillis() || 0);
                            const dateB = b.scheduledDate?.toMillis ? b.scheduledDate.toMillis() : (b.createdAt?.toMillis() || 0);
                            return dateB - dateA;
                        });

                    state.upcomingFixtures = allFixtures
                        .filter(f => f.status === 'scheduled')
                        .sort((a, b) => {
                            const dateA = a.scheduledDate?.toMillis ? a.scheduledDate.toMillis() : 0;
                            const dateB = b.scheduledDate?.toMillis ? b.scheduledDate.toMillis() : 0;
                            return dateA - dateB;
                        });

                    render();
                }, (error) => handleError(error, 'fixtures'));

                    // Store all unsubscribe functions
                    state.unsubscribeFunctions.push(seasonsUnsub, playersUnsub, fixturesUnsub);
            }

            ui.themeToggleBtnMobile.addEventListener('click', handleThemeToggle);

            document.querySelector('[data-role="viewer"]').addEventListener('click', () => {
                state.userRole = 'viewer';
                state.isLoggedIn = false;
                state.activeMatchView = 'A'; // Viewers default to Team A but can switch
                localStorage.setItem('userRole', 'viewer');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('loginTimestamp');
                ui.roleSelectionOverlay.classList.add('hidden');
                ui.mainApp.classList.remove('hidden');
                render();
            });

            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('email-signin-btn').addEventListener('click', handleEmailSignIn);
            document.getElementById('create-account-btn').addEventListener('click', openSignupModal);
            document.getElementById('signup-modal-close').addEventListener('click', closeSignupModal);
            document.getElementById('signup-modal-cancel').addEventListener('click', closeSignupModal);
            document.getElementById('signup-modal-submit').addEventListener('click', handleEmailSignUp);


            Object.keys(ui.tabs).forEach(tabName => {
                ui.tabs[tabName].addEventListener('click', () => switchTab(tabName));
            });
            ui.addSeasonBtn.addEventListener('click', async () => {
                const name = ui.newSeasonInput.value.trim();
                if (!name) return showToast("Season name cannot be empty.", 'warning');
                try {
                    await safeFirebaseCall('addSeason', async () => {
                        return await addDoc(collection(state.db, SEASONS_COLLECTION), { name, status: 'archived' });
                    });
                    showToast(`Season "${name}" added.`);
                    ui.newSeasonInput.value = '';
                } catch(e) {
                    if (e.message.includes('Rate limit')) {
                        showToast(e.message, 'error');
                    } else {
                        showToast("Could not add season.", 'error');
                    }
                }
            });
            ui.seasonsList.addEventListener('click', async (e) => {
                const setActiveBtn = e.target.closest('.set-active-season-btn');
                if (setActiveBtn) {
                    const newActiveId = setActiveBtn.dataset.seasonId;
                    const batch = writeBatch(state.db);
                    state.seasons.forEach(season => {
                        const seasonRef = doc(state.db, SEASONS_COLLECTION, season.id);
                        batch.update(seasonRef, { status: season.id === newActiveId ? 'active' : 'archived' });
                    });
                    await batch.commit();
                    showToast("Active season updated.");
                }
            });
            ui.createFixtureBtn.addEventListener('click', createFixture);

            // Add the update teams function
            window.updateTeamSelections = async function() {
                if (!state.fixture.id) return;

                // Validate all games have players selected
                const games = [];
                for (let i = 0; i < GAME_TITLES.length; i++) {
                    const title = GAME_TITLES[i];
                    const isDoubles = title.includes("Doubles");

                    const p1Input = document.getElementById(`game-${i}-p1-input`);
                    const p1Value = p1Input.value.trim();
                    
                    const p1Id = await getOrCreatePlayer(p1Value);
                    if (!p1Id && p1Value) {
                        showToast(`Could not add player for ${title}.`, 'error');
                        return;
                    }
                    
                    const playerIds = p1Id ? [p1Id] : [];
                    
                    if (isDoubles) {
                        const p2Input = document.getElementById(`game-${i}-p2-input`);
                        const p2Value = p2Input.value.trim();
                        
                        const p2Id = await getOrCreatePlayer(p2Value);
                        
                        if (p1Id && p2Id && p1Id === p2Id) {
                            showToast(`A player cannot play with themselves in ${title}.`, 'error');
                            return;
                        }
                        
                        if (p2Id) playerIds.push(p2Id);
                    }

                    // Keep existing game data but update player selections
                    const existingGame = state.fixture.games[i];
                    const updatedGame = {
                        ...existingGame,
                        playerIds: playerIds,
                        type: isDoubles ? 'doubles' : 'singles'
                    };

                    // If player selection changed, reset player-specific scores but keep game stats
                    if (JSON.stringify(existingGame.playerIds) !== JSON.stringify(playerIds)) {
                        updatedGame.playerScores = playerIds.map(() => ({
                            scores100: 0,
                            scores140: 0,
                            scores180: 0,
                            sillyThings: 0,
                        }));
                    }

                    games.push(updatedGame);
                }

                try {
                    const fixtureRef = doc(state.db, FIXTURES_COLLECTION, state.fixture.id);
                    await updateDoc(fixtureRef, { games: games });
                    showToast("Team selections updated successfully!");
                    switchTab('live');
                } catch (error) {
                    console.error("Error updating teams:", error);
                    showToast("Could not update team selections.", 'error');
                }
            };
            ui.prevGameBtn.addEventListener('click', () => {
                if (state.currentGameIndex > 0) {
                    triggerHaptic('light');
                    state.currentGameIndex--;
                    state.fixture.activeGameIndex = state.currentGameIndex;
                    const game = state.fixture.games[state.currentGameIndex];
                    game.turnSeq = (game.turnSeq || 0) + 1;
                    render();
                    updateGameData();
                }
            });
            ui.nextGameBtn.addEventListener('click', () => {
                if (state.currentGameIndex < state.fixture.games.length - 1) {
                    triggerHaptic('light');
                    state.currentGameIndex++;
                    state.fixture.activeGameIndex = state.currentGameIndex;
                    const game = state.fixture.games[state.currentGameIndex];
                    game.turnSeq = (game.turnSeq || 0) + 1;
                    render();
                    updateGameData();
                }
            });

            ui.liveMatchContent.addEventListener('click', (e) => {
                const statBtn = e.target.closest('.stat-btn');
                if (statBtn) {
                     triggerHaptic('light');
                     const playerIndex = statBtn.hasAttribute('data-player-index') ? parseInt(statBtn.dataset.playerIndex) : 0;
                     updateStat(statBtn.dataset.stat, parseInt(statBtn.dataset.op), playerIndex);
                }
            });


            // Fixtures tab event listeners
            ui.fixturesTabUpcoming.addEventListener('click', () => {
                state.activeFixturesTab = 'upcoming';
                render();
            });

            ui.fixturesTabPrevious.addEventListener('click', () => {
                state.activeFixturesTab = 'previous';
                render();
            });

            ui.addFixtureBtn.addEventListener('click', addScheduledFixture);

            // Upcoming fixtures list events
            ui.upcomingFixturesList.addEventListener('click', (e) => {
                const selectBtn = e.target.closest('.select-upcoming-match-btn');
                const startBtn = e.target.closest('.start-match-btn');
                const deleteBtn = e.target.closest('.delete-upcoming-fixture-btn');

                if (deleteBtn) {
                    e.stopPropagation();
                    deleteUpcomingFixture(deleteBtn.dataset.fixtureId);
                    return;
                }

                if (startBtn) {
                    e.stopPropagation();
                    startMatchFromScheduled(startBtn.dataset.fixtureId);
                    return;
                }

                if (selectBtn) {
                    const fixtureId = selectBtn.dataset.fixtureId;
                    openFixtureModal(fixtureId, 'upcoming');
                }
            });

            // Previous fixtures list events
            ui.previousFixturesList.addEventListener('click', (e) => {
                const selectBtn = e.target.closest('.select-previous-match-btn');
                const deleteBtn = e.target.closest('.delete-previous-fixture-btn');

                if (deleteBtn) {
                    e.stopPropagation();
                    deletePreviousFixture(deleteBtn.dataset.fixtureId);
                    return;
                }

                if (selectBtn) {
                    const fixtureId = selectBtn.dataset.fixtureId;
                    openFixtureModal(fixtureId, 'previous');
                }
            });

            ui.finesList.addEventListener('click', (e) => {
                const payBtn = e.target.closest('.pay-fines-btn');
                if (payBtn) {
                    const player = state.players.find(p => p.id === payBtn.dataset.playerId);
                    const allTimeStats = getPlayerStats(player, 'all-time', 'singles');
                    const fineAmount = `£${(allTimeStats.outstandingFines / 100).toFixed(2)}`;

                    openConfirmModal(
                        `Clear ${player?.name || 'Player'}'s Fines?`,
                        `Are you sure you want to mark ${fineAmount} in outstanding fines as paid? This action cannot be undone.`,
                        'clearPlayerFines',
                        payBtn.dataset.playerId
                    );
                }
            });

            ui.seasonFilterSelect.addEventListener('change', (e) => {
                state.selectedStatsSeasonId = e.target.value;
                renderLeaderboard();
            });

            document.getElementById('team-filter-select')?.addEventListener('change', (e) => {
                state.selectedStatsTeamFilter = e.target.value;
                renderLeaderboard();
            });

            ui.leaderboardBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.playerId) {
                    state.playerCard = { isOpen: true, playerId: row.dataset.playerId, selectedSeasonId: state.selectedStatsSeasonId };
                    renderPlayerCard();
                }
            });

            ui.playerCardModal.closeBtn.addEventListener('click', () => {
                state.playerCard.isOpen = false;
                renderPlayerCard();
                closeFixtureModal();
            });

            ui.playerCardModal.content.addEventListener('change', (e) => {
                if (e.target.id === 'player-card-season-select') {
                    state.playerCard.selectedSeasonId = e.target.value;
                    renderPlayerCard();
                }
            });

            ui.highCheckoutInput.addEventListener('input', (e) => {
                const game = state.fixture.games[state.currentGameIndex];
                if (game) {
                    game.highCheckout = parseInt(e.target.value) || 0;
                    updateGameData();
                }
            });
            ui.liveMatchContent.addEventListener('input', (e) => {
                if (e.target.classList.contains('player-high-checkout-input')) {
                    const game = state.fixture.games[state.currentGameIndex];
                    if (game && game.playerScores) {
                        const playerIndex = parseInt(e.target.dataset.playerIndex);
                        if (!game.playerScores[playerIndex]) game.playerScores[playerIndex] = {};
                        game.playerScores[playerIndex].highCheckout = parseInt(e.target.value) || 0;
                        updateGameData();
                    }
                }
            });
            let fineDebounce = {};
            ui.fineBtn26.addEventListener('click', () => {
                const key = 'fine-26';
                if (fineDebounce[key]) return; // Prevent rapid clicks
                
                fineDebounce[key] = true;
                setTimeout(() => delete fineDebounce[key], 2000); // 2 second cooldown
                
                triggerHaptic('medium');
                addFine(26, 'Score of 26');
            });
            ui.fineBtnMiss.addEventListener('click', () => {
                const key = 'fine-miss';
                if (fineDebounce[key]) return; // Prevent rapid clicks
                
                fineDebounce[key] = true;
                setTimeout(() => delete fineDebounce[key], 2000); // 2 second cooldown
                
                triggerHaptic('medium');
                addFine(50, 'Missed Board');
            });
            ui.fineBtnLowScore.addEventListener('click', () => {
                triggerHaptic('light');
                openLowScoreModal();
            });
            ui.lowScoreModal.cancel.addEventListener('click', closeLowScoreModal);
            ui.lowScoreModal.submit.addEventListener('click', submitLowScoreFine);
            ui.lowScoreModal.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitLowScoreFine(); });
            ui.finesPanel.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-fine-btn');
                if (removeBtn) {
                    removeFine(removeBtn.dataset.fineId);
                }
            });
            ui.gameActionButtons.addEventListener('click', (e) => {
                if (e.target.id === 'finish-match-btn') openDotdModal();
            });

            ui.dotdModal.finish.addEventListener('click', () => {
                triggerHaptic('heavy');
                const selectedPlayer = document.querySelector('input[name="dotd-vote"]:checked');
                finishMatch(selectedPlayer ? selectedPlayer.value : null);
            });

            document.getElementById('dotd-close-btn').addEventListener('click', () => {
                ui.dotdModal.overlay.classList.add('hidden');
                ui.dotdModal.overlay.classList.remove('flex');
                document.body.classList.remove('modal-open');
            });

            ui.confirmModal.cancel.addEventListener('click', closeConfirmModal);
            ui.confirmModal.confirm.addEventListener('click', handleConfirmation);

            ui.hamburgerBtn.addEventListener('click', openMobileMenu);
            ui.closeMenuBtn.addEventListener('click', closeMobileMenu);
            ui.mobileMenuOverlay.addEventListener('click', (e) => {
                if (e.target === ui.mobileMenuOverlay) {
                    closeMobileMenu();
                }
            });
            ui.mobileNavLinks.addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('a[data-tab-name]');
                if (link) {
                    switchTab(link.dataset.tabName);
                }
            });

            ui.h2h.player1Select.addEventListener('change', (e) => {
                state.h2h.player1 = e.target.value;
                calculateAndRenderH2H();
            });
            ui.h2h.player2Select.addEventListener('change', (e) => {
                state.h2h.player2 = e.target.value;
                calculateAndRenderH2H();
            });

            // Team switcher event listeners
            document.getElementById('match-view-team-a').addEventListener('click', () => {
                state.activeMatchView = 'A';
                updateTeamSwitcherStyles('match');
                renderCurrentMatch();
            });
            
            document.getElementById('match-view-team-b').addEventListener('click', () => {
                state.activeMatchView = 'B';
                updateTeamSwitcherStyles('match');
                renderCurrentMatch();
            });
            
            document.getElementById('fixtures-view-team-a').addEventListener('click', () => {
                state.activeMatchView = 'A';
                updateTeamSwitcherStyles('fixtures');
                renderFixturesTab();
            });
            
            document.getElementById('fixtures-view-team-b').addEventListener('click', () => {
                state.activeMatchView = 'B';
                updateTeamSwitcherStyles('fixtures');
                renderFixturesTab();
            });

            // My Profile Listeners
            ui.myProfile.playerSelect.addEventListener('change', async (e) => {
                const newPlayerId = e.target.value;

                // If user is logged in, update their player link in the database
                if (state.isLoggedIn && state.userId) {
                    try {
                        await updateDoc(doc(state.db, 'users', state.userId), {
                            playerId: newPlayerId || null,
                            updatedAt: serverTimestamp()
                        });
                        state.userPlayerId = newPlayerId || null;
                        showToast('Player profile linked successfully!');
                    } catch (error) {
                        console.error('Error linking player profile:', error);
                        showToast('Failed to link player profile.', 'error');
                    }
                } else {
                    // Fallback for manual selection
                    state.myProfile.selectedPlayerId = newPlayerId;
                }

                renderMyProfile();
            });
            ui.myProfile.saveBtn.addEventListener('click', handleUpdateProfile);

        
            // Column visibility controls
            document.getElementById('toggle-columns-btn').addEventListener('click', () => {
                const controls = document.getElementById('column-controls');
                const isHidden = controls.classList.contains('hidden');
                
                if (isHidden) {
                    controls.classList.remove('hidden');
                } else {
                    controls.classList.add('hidden');
                }
            });

            document.getElementById('select-all-columns').addEventListener('click', () => {
                Object.keys(state.columnVisibility).forEach(column => {
                    state.columnVisibility[column] = true;
                });
                renderLeaderboard();
            });

            document.getElementById('deselect-all-columns').addEventListener('click', () => {
                Object.keys(state.columnVisibility).forEach(column => {
                    state.columnVisibility[column] = false;
                });
                renderLeaderboard();
            });

            document.querySelectorAll('.column-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const column = e.target.dataset.column;
                    state.columnVisibility[column] = e.target.checked;
                    renderLeaderboard();
                });
            });
        }
        ui.headerSignoutBtn.addEventListener('click', handleHeaderButtonClick);
        ui.myProfile.saveBtn.addEventListener('click', handleUpdateProfile);
        document.getElementById('stats-table-header').addEventListener('click', (e) => {
                const header = e.target.closest('th[data-sort]');
                if (!header) return;

                triggerHaptic('light');
                const newColumn = header.dataset.sort;
                const currentSort = state.leaderboardSort;

                if (newColumn === currentSort.column) {
                    // Same column, flip direction
                    currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    // New column, default to desc
                    currentSort.column = newColumn;
                    currentSort.direction = 'desc';
                }
                renderLeaderboard();
            });
            // Admin player management
            document.addEventListener('click', (e) => {
                if (e.target.id === 'admin-add-player-btn') {
                    addPlayer();
                }
            });
    
            init();
        
        function updateTeamSwitcherStyles(context) {
            const prefix = context === 'match' ? 'match-view' : 'fixtures-view';
            const btnA = document.getElementById(`${prefix}-team-a`);
            const btnB = document.getElementById(`${prefix}-team-b`);
            
            if (!btnA || !btnB) return;
            
            // If logged-in user has no team (not viewer), disable both buttons
            if (!state.userTeam && state.isLoggedIn && state.userRole !== 'viewer') {
                btnA.disabled = true;
                btnB.disabled = true;
                btnA.classList.add('opacity-50', 'cursor-not-allowed');
                btnB.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            // Enable buttons for viewers or users with teams
            btnA.disabled = false;
            btnB.disabled = false;
            btnA.classList.remove('opacity-50', 'cursor-not-allowed');
            btnB.classList.remove('opacity-50', 'cursor-not-allowed');
            
            // If no active view set yet, default to user's team (or A for viewers/unassigned)
            if (!state.activeMatchView) {
                state.activeMatchView = state.userTeam || 'A';
            }
            
            if (state.activeMatchView === 'A') {
                btnA.classList.add('bg-emerald-600', 'text-white');
                btnA.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                btnB.classList.remove('bg-emerald-600', 'text-white');
                btnB.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
            } else {
                btnB.classList.add('bg-emerald-600', 'text-white');
                btnB.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                btnA.classList.remove('bg-emerald-600', 'text-white');
                btnA.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
            }
        }
    </script>
</body>
</html>
